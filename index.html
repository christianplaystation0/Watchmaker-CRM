<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WatchmakerCRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase Auth -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --yellow: #FFD60A;
      --yellow-hover: #E6C009;
      --black: #1A1A1A;
      --dark-gray: #2D2D2D;
      --medium-gray: #6B6B6B;
      --light-gray: #E8E8E8;
      --off-white: #F5F5F5;
      --white: #FFFFFF;
      --purple: #8B5CF6;
      --purple-light: #EDE9FE;
      --green: #22C55E;
      --green-light: #DCFCE7;
      --red: #EF4444;
      --red-light: #FEE2E2;
      --orange: #F97316;
      --orange-light: #FFEDD5;
      --blue: #3B82F6;
      --blue-light: #DBEAFE;
      --radius: 12px;
      --radius-lg: 16px;
      --shadow: 0 4px 20px rgba(0,0,0,0.08);
      --shadow-hover: 0 8px 30px rgba(0,0,0,0.12);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      overflow-x: hidden;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--off-white);
      color: var(--black);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .hidden { display: none !important; }

    /* ===== LAYOUT WITH SIDEBAR ===== */
    .app-layout {
      display: flex;
      min-height: 100vh;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: 260px;
      background: var(--black);
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }

    .sidebar-logo {
      font-size: 22px;
      font-weight: 700;
      color: var(--white);
      padding: 0 24px 24px;
      border-bottom: 1px solid var(--dark-gray);
      margin-bottom: 24px;
    }

    .sidebar-logo span {
      color: var(--yellow);
    }

    .sidebar-section {
      margin-bottom: 24px;
    }

    .sidebar-section-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--medium-gray);
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 0 24px;
      margin-bottom: 12px;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
    }

    .sidebar-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      color: var(--white);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      opacity: 0.7;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      background: none;
      text-align: left;
      width: 100%;
      position: relative;
    }

    .sidebar-link:hover {
      opacity: 1;
      background: rgba(255,255,255,0.05);
    }

    .sidebar-link.active {
      opacity: 1;
      background: rgba(255,255,255,0.1);
      border-left: 3px solid var(--yellow);
    }

    .sidebar-link-icon {
      font-size: 18px;
    }

    /* Notification Badge */
    .notification-badge {
      background: var(--red);
      color: white;
      font-size: 11px;
      font-weight: 600;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 0 5px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* User Info Section */
    .sidebar-user {
      margin-top: auto;
      padding: 20px 24px;
      border-top: 1px solid var(--dark-gray);
    }

    .sidebar-user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .sidebar-user-avatar {
      width: 36px;
      height: 36px;
      background: var(--yellow);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--black);
      font-size: 14px;
    }

    .sidebar-user-email {
      font-size: 12px;
      color: var(--medium-gray);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 160px;
    }

    .logout-btn {
      width: 100%;
      padding: 10px 16px;
      background: transparent;
      border: 1px solid var(--dark-gray);
      border-radius: var(--radius);
      color: var(--white);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .logout-btn:hover {
      background: var(--dark-gray);
      border-color: var(--medium-gray);
    }

    /* ===== PROFILE PAGE ===== */
    .profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .profile-card {
      background: var(--white);
      padding: 28px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }

    .profile-card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--black);
      margin-bottom: 8px;
    }

    .profile-card-subtitle {
      font-size: 13px;
      color: var(--medium-gray);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .profile-message {
      margin-top: 16px;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      display: none;
    }

    .profile-message.success {
      display: block;
      background: var(--green-light);
      color: var(--green);
    }

    .profile-message.error {
      display: block;
      background: var(--red-light);
      color: var(--red);
    }

    /* Color Picker */
    .color-picker-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
    }

    .color-option {
      aspect-ratio: 1;
      border-radius: 12px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.selected {
      border-color: var(--black);
      box-shadow: 0 0 0 3px var(--yellow);
    }

    .color-option.taken {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .color-option.taken::after {
      content: 'âœ“';
      color: white;
      font-size: 16px;
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    .color-option .color-tooltip {
      position: absolute;
      bottom: -24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      color: var(--medium-gray);
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .color-option:hover .color-tooltip {
      opacity: 1;
    }

    /* Team Members Grid */
    .team-members-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .team-member-card {
      background: var(--white);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .team-member-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
      font-size: 16px;
      flex-shrink: 0;
    }

    .team-member-info {
      flex: 1;
      min-width: 0;
    }

    .team-member-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--black);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .team-member-email {
      font-size: 12px;
      color: var(--medium-gray);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Assigned User Badge */
    .assigned-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      background: var(--off-white);
    }

    .assigned-badge .user-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    /* Task Comments */
    .task-comments-section {
      margin-top: 24px;
      border-top: 1px solid var(--light-gray);
      padding-top: 20px;
    }

    .task-comments-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--black);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .task-comments-title .comment-count {
      background: var(--light-gray);
      color: var(--dark-gray);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .task-comments-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 250px;
      overflow-y: auto;
      margin-bottom: 16px;
      padding-right: 4px;
    }

    .task-comments-list::-webkit-scrollbar {
      width: 6px;
    }

    .task-comments-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .task-comments-list::-webkit-scrollbar-thumb {
      background: var(--light-gray);
      border-radius: 3px;
    }

    .task-comment {
      display: flex;
      gap: 12px;
      padding: 14px;
      background: var(--off-white);
      border-radius: var(--radius);
      animation: slideIn 0.3s ease-out;
      transition: all 0.2s;
    }

    .task-comment:hover {
      background: #ECECEC;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .task-comment-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
      font-size: 13px;
      flex-shrink: 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .task-comment-content {
      flex: 1;
      min-width: 0;
    }

    .task-comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .task-comment-author {
      font-size: 13px;
      font-weight: 600;
      color: var(--black);
    }

    .task-comment-time {
      font-size: 11px;
      color: var(--medium-gray);
    }

    .task-comment-text {
      font-size: 13px;
      color: var(--dark-gray);
      line-height: 1.5;
      word-wrap: break-word;
    }

    .task-comment-input-row {
      display: flex;
      gap: 10px;
      background: var(--off-white);
      padding: 12px;
      border-radius: var(--radius);
      align-items: center;
      position: relative;
    }

    .task-comment-input {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 24px;
      font-size: 13px;
      font-family: inherit;
      background: var(--white);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
    }

    .task-comment-input:focus {
      outline: none;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.06), 0 0 0 2px var(--yellow);
    }

    .task-comment-input::placeholder {
      color: var(--medium-gray);
    }

    .task-comment-btn {
      padding: 12px 20px;
      background: var(--yellow);
      color: var(--black);
      border: none;
      border-radius: 24px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .task-comment-btn:hover {
      background: var(--yellow-hover);
      transform: scale(1.02);
    }

    .task-comment-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .task-comment-btn .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid transparent;
      border-top-color: var(--black);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .no-comments {
      text-align: center;
      padding: 32px 20px;
      color: var(--medium-gray);
      font-size: 14px;
      background: var(--off-white);
      border-radius: var(--radius);
    }

    .no-comments-icon {
      font-size: 32px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    /* ===== NOTIFICATIONS ===== */
    .notifications-actions {
      margin-bottom: 20px;
    }

    .notifications-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .notification-item {
      background: var(--white);
      padding: 20px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      display: flex;
      gap: 16px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 4px solid var(--yellow);
    }

    .notification-item:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-hover);
    }

    .notification-item.read {
      border-left-color: var(--light-gray);
      opacity: 0.7;
    }

    .notification-item.read:hover {
      opacity: 1;
    }

    .notification-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--yellow);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .notification-item.read .notification-icon {
      background: var(--light-gray);
    }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--black);
      margin-bottom: 4px;
    }

    .notification-message {
      font-size: 13px;
      color: var(--medium-gray);
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .notification-meta {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .notification-time {
      font-size: 12px;
      color: var(--medium-gray);
    }

    .notification-badge-new {
      background: var(--yellow);
      color: var(--black);
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      text-transform: uppercase;
    }

    .notification-item.read .notification-badge-new {
      display: none;
    }

    .no-notifications {
      text-align: center;
      padding: 60px 20px;
      color: var(--medium-gray);
    }

    .no-notifications-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .no-notifications-text {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .no-notifications-subtext {
      font-size: 13px;
    }

    /* ===== TASK TABS ===== */
    .task-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--light-gray);
      padding-bottom: 0;
    }

    .task-tab {
      padding: 12px 20px;
      background: none;
      border: none;
      font-size: 14px;
      font-weight: 500;
      color: var(--medium-gray);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .task-tab:hover {
      color: var(--black);
    }

    .task-tab.active {
      color: var(--black);
    }

    .task-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--yellow);
    }

    .my-tasks-count {
      background: var(--light-gray);
      color: var(--dark-gray);
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .task-tab.active .my-tasks-count {
      background: var(--yellow);
      color: var(--black);
    }

    /* Private Task Indicator */
    .private-badge {
      background: var(--dark-gray);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
    }

    /* Archived Task Indicator */
    .archived-badge {
      background: var(--medium-gray);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
    }

    /* @Mention highlighting */
    .mention {
      background: var(--blue-light);
      color: var(--blue);
      padding: 1px 4px;
      border-radius: 4px;
      font-weight: 500;
    }

    /* Mention autocomplete dropdown */
    .mention-autocomplete {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--light-gray);
      border-radius: var(--radius);
      box-shadow: var(--shadow-hover);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      margin-bottom: 8px;
    }

    .mention-autocomplete.hidden {
      display: none;
    }

    .mention-autocomplete-item {
      padding: 10px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s;
    }

    .mention-autocomplete-item:hover,
    .mention-autocomplete-item.selected {
      background: var(--blue-light);
    }

    .mention-autocomplete-item-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 12px;
    }

    .mention-autocomplete-item-name {
      font-weight: 500;
      color: var(--black);
    }

    .mention-autocomplete-item-email {
      font-size: 12px;
      color: var(--medium-gray);
    }

    /* Notification badge */
    .notification-badge {
      background: var(--red);
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 8px;
      min-width: 18px;
      text-align: center;
    }

    /* Notification item styles */
    .notification-item {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: white;
      border-radius: var(--radius);
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }

    .notification-item:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-1px);
    }

    .notification-item.unread {
      border-left-color: var(--blue);
      background: var(--blue-light);
    }

    .notification-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--blue);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-title {
      font-weight: 600;
      color: var(--black);
      margin-bottom: 4px;
    }

    .notification-message {
      color: var(--medium-gray);
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .notification-time {
      font-size: 12px;
      color: var(--medium-gray);
      margin-top: 4px;
    }

    .notification-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .mark-read-btn {
      padding: 6px 12px;
      font-size: 12px;
      background: var(--light-gray);
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .mark-read-btn:hover {
      background: var(--medium-gray);
      color: white;
    }

    /* Checkbox Styling */
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
    }

    .checkbox-input {
      width: 20px;
      height: 20px;
      accent-color: var(--yellow);
      cursor: pointer;
    }

    .checkbox-label {
      font-size: 14px;
      color: var(--dark-gray);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .checkbox-label .lock-icon {
      font-size: 14px;
    }

    /* ===== MAIN CONTENT ===== */
    .main-content {
      flex: 1;
      margin-left: 260px;
      min-height: 100vh;
    }

    /* ===== HEADER ===== */
    .header {
      background: var(--white);
      padding: 20px 48px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--light-gray);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--black);
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    /* ===== CONTAINER ===== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 48px;
    }

    /* ===== PAGE TITLE ===== */
    .page-title {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--black);
    }

    .page-subtitle {
      font-size: 16px;
      color: var(--medium-gray);
      margin-bottom: 32px;
    }

    /* ===== BUTTONS ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--yellow);
      color: var(--black);
    }

    .btn-primary:hover {
      background: var(--yellow-hover);
    }

    .btn-secondary {
      background: var(--black);
      color: var(--white);
    }

    .btn-secondary:hover {
      background: var(--dark-gray);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--light-gray);
      color: var(--dark-gray);
    }

    .btn-outline:hover {
      border-color: var(--black);
      color: var(--black);
    }

    .btn-danger {
      background: var(--red);
      color: var(--white);
    }

    .btn-danger:hover {
      background: #DC2626;
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 13px;
    }

    /* ===== KPI CARDS ===== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .kpi-card {
      background: var(--white);
      padding: 24px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
    }

    .kpi-card.highlight {
      background: var(--yellow);
    }

    .kpi-card.purple {
      background: var(--purple-light);
    }

    .kpi-card.green {
      background: var(--green-light);
    }

    .kpi-card.red {
      background: var(--red-light);
    }

    .kpi-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--medium-gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .kpi-card.highlight .kpi-label,
    .kpi-card.purple .kpi-label,
    .kpi-card.green .kpi-label,
    .kpi-card.red .kpi-label {
      color: var(--dark-gray);
    }

    .kpi-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--black);
    }

    /* ===== SECTION ===== */
    .section {
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--black);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 24px;
      background: var(--yellow);
      border-radius: 2px;
    }

    /* ===== CLIENT GRID ===== */
    .client-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .client-card {
      background: var(--white);
      padding: 24px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      text-align: center;
    }

    .client-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
      border-color: var(--yellow);
    }

    .client-card-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--black);
    }

    .client-card-icon {
      width: 48px;
      height: 48px;
      background: var(--off-white);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      font-size: 20px;
      font-weight: 700;
      color: var(--dark-gray);
    }

    /* ===== CHARTS GRID ===== */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .chart-card {
      background: var(--white);
      padding: 24px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--black);
    }

    .chart-container {
      height: 280px;
      position: relative;
    }

    /* ===== UPLOAD SECTION ===== */
    .upload-card {
      background: var(--white);
      padding: 32px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .drop-zone {
      border: 3px dashed var(--light-gray);
      border-radius: var(--radius);
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--off-white);
    }

    .drop-zone:hover {
      border-color: var(--yellow);
      background: #FFFEF5;
    }

    .drop-zone-icon {
      font-size: 40px;
      margin-bottom: 12px;
    }

    .drop-zone-text {
      font-size: 16px;
      font-weight: 500;
      color: var(--dark-gray);
      margin-bottom: 6px;
    }

    .drop-zone-hint {
      font-size: 13px;
      color: var(--medium-gray);
    }

    #status {
      margin-top: 12px;
      font-size: 14px;
      font-weight: 500;
      color: var(--green);
    }

    /* ===== JSON BOX ===== */
    .json-card {
      background: var(--black);
      padding: 24px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }

    .json-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--medium-gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    #rawJson {
      background: var(--dark-gray);
      color: #A3E635;
      padding: 20px;
      border-radius: var(--radius);
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      line-height: 1.6;
      height: 160px;
      overflow: auto;
      margin: 0;
    }

    /* ===== BACK BUTTON ===== */
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: var(--black);
      color: var(--white);
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 24px;
    }

    .back-btn:hover {
      background: var(--dark-gray);
    }

    /* ===== TABLES ===== */
    .table-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px; /* Ensures table doesn't squish on mobile */
    }

    th {
      background: var(--black);
      color: var(--white);
      padding: 16px 20px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 16px 20px;
      border-bottom: 1px solid var(--light-gray);
      font-size: 14px;
      color: var(--dark-gray);
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: var(--off-white);
    }

    /* ===== BADGES ===== */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-low { background: var(--blue-light); color: var(--blue); }
    .badge-medium { background: var(--green-light); color: var(--green); }
    .badge-high { background: var(--orange-light); color: var(--orange); }
    .badge-urgent { background: var(--red-light); color: var(--red); }

    .badge-backlog { background: var(--light-gray); color: var(--medium-gray); }
    .badge-todo { background: var(--blue-light); color: var(--blue); }
    .badge-in_progress { background: var(--purple-light); color: var(--purple); }
    .badge-review { background: var(--orange-light); color: var(--orange); }
    .badge-done { background: var(--green-light); color: var(--green); }

    /* ===== MODAL ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.2s;
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--medium-gray);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--light-gray);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* ===== FORM ===== */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--dark-gray);
      margin-bottom: 6px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--light-gray);
      border-radius: var(--radius);
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--yellow);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* ===== KANBAN ===== */
    .kanban-board {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding-bottom: 20px;
    }

    .kanban-column {
      min-width: 280px;
      max-width: 280px;
      background: var(--off-white);
      border-radius: var(--radius-lg);
      padding: 16px;
    }

    .kanban-column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .kanban-column-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--dark-gray);
    }

    .kanban-column-count {
      background: var(--white);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--medium-gray);
    }

    .kanban-cards {
      min-height: 200px;
    }

    .kanban-card {
      background: var(--white);
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 12px;
      cursor: grab;
      transition: all 0.2s;
    }

    .kanban-card:hover {
      box-shadow: var(--shadow-hover);
    }

    .kanban-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .kanban-card-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--black);
      margin-bottom: 10px;
    }

    .kanban-card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .kanban-card-due {
      font-size: 12px;
      color: var(--medium-gray);
    }

    /* ===== FILTERS ===== */
    .filters-row {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 10px 14px;
      border: 2px solid var(--light-gray);
      border-radius: var(--radius);
      font-size: 13px;
      background: var(--white);
      cursor: pointer;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--yellow);
    }

    /* ===== ACTION BUTTONS ===== */
    .action-btn {
      background: none;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .action-btn:hover {
      background: var(--off-white);
    }

    .action-btn.edit { color: var(--blue); }
    .action-btn.delete { color: var(--red); }

    /* ===== PROJECT KANBAN ===== */
    .projects-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .client-selector {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }

    .client-selector-btn {
      padding: 12px 20px;
      border: 2px solid var(--light-gray);
      border-radius: var(--radius);
      background: var(--white);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .client-selector-btn:hover {
      border-color: var(--yellow);
      background: #FFFEF5;
    }

    .client-selector-btn.active {
      border-color: var(--yellow);
      background: var(--yellow);
      color: var(--black);
    }

    .project-kanban-board {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding-bottom: 20px;
      min-height: 500px;
    }

    .project-column {
      min-width: 320px;
      max-width: 320px;
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 300px);
    }

    .project-column-header {
      padding: 20px;
      border-bottom: 3px solid var(--yellow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .project-column-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--black);
    }

    .project-column-count {
      background: var(--off-white);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      color: var(--medium-gray);
    }

    .project-column-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      min-height: 200px;
    }

    .project-column-body.drag-over {
      background: var(--off-white);
    }

    .project-task-card {
      background: var(--off-white);
      padding: 16px;
      border-radius: var(--radius);
      margin-bottom: 12px;
      cursor: grab;
      transition: all 0.2s;
      border-left: 4px solid transparent;
    }

    .project-task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .project-task-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .project-task-card.priority-low { border-left-color: var(--blue); }
    .project-task-card.priority-medium { border-left-color: var(--green); }
    .project-task-card.priority-high { border-left-color: var(--orange); }
    .project-task-card.priority-urgent { border-left-color: var(--red); }

    .project-task-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--black);
      margin-bottom: 10px;
    }

    .project-task-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .project-task-assignee {
      font-size: 12px;
      color: var(--medium-gray);
    }

    .project-task-due {
      font-size: 11px;
      color: var(--medium-gray);
      background: var(--white);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .project-task-due.overdue {
      background: var(--red-light);
      color: var(--red);
    }

    .add-task-btn {
      width: 100%;
      padding: 12px;
      background: transparent;
      border: 2px dashed var(--light-gray);
      border-radius: var(--radius);
      color: var(--medium-gray);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
    }

    .add-task-btn:hover {
      border-color: var(--yellow);
      color: var(--black);
      background: #FFFEF5;
    }

    .add-project-column {
      min-width: 280px;
      max-width: 280px;
      background: var(--off-white);
      border-radius: var(--radius-lg);
      border: 2px dashed var(--light-gray);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .add-project-column:hover {
      border-color: var(--yellow);
      background: #FFFEF5;
    }

    .add-project-text {
      font-size: 14px;
      font-weight: 500;
      color: var(--medium-gray);
    }

    .project-empty-state {
      text-align: center;
      padding: 60px 40px;
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }

    .project-empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .project-empty-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--black);
      margin-bottom: 8px;
    }

    .project-empty-text {
      font-size: 14px;
      color: var(--medium-gray);
      margin-bottom: 24px;
    }

    /* Project Actions */
    .project-column-actions {
      display: flex;
      gap: 8px;
    }

    .project-action-btn {
      padding: 6px 10px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 12px;
      color: var(--medium-gray);
      border-radius: 4px;
      transition: all 0.2s;
    }

    .project-action-btn:hover {
      background: var(--off-white);
      color: var(--black);
    }

    .project-action-btn.delete:hover {
      background: var(--red-light);
      color: var(--red);
    }

    /* ===== CLIENT REVENUE ACCORDION ===== */
    .client-revenue-accordion {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .client-revenue-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .client-revenue-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .client-revenue-header:hover {
      background: var(--off-white);
    }

    .client-revenue-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .client-revenue-icon {
      width: 48px;
      height: 48px;
      background: var(--yellow);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      color: var(--black);
    }

    .client-revenue-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--black);
    }

    .client-revenue-summary {
      font-size: 13px;
      color: var(--medium-gray);
      margin-top: 4px;
    }

    .client-revenue-totals {
      display: flex;
      gap: 32px;
      text-align: right;
    }

    .client-revenue-total {
      display: flex;
      flex-direction: column;
    }

    .client-revenue-total-label {
      font-size: 11px;
      color: var(--medium-gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .client-revenue-total-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--black);
    }

    .client-revenue-total-value.highlight {
      color: var(--yellow);
      background: var(--black);
      padding: 4px 12px;
      border-radius: 6px;
    }

    .client-revenue-toggle {
      font-size: 20px;
      color: var(--medium-gray);
      transition: transform 0.2s;
    }

    .client-revenue-card.open .client-revenue-toggle {
      transform: rotate(180deg);
    }

    .client-revenue-body {
      display: none;
      padding: 0 24px 24px;
      border-top: 1px solid var(--light-gray);
    }

    .client-revenue-card.open .client-revenue-body {
      display: block;
    }

    .client-revenue-tables {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-top: 20px;
    }

    .client-revenue-table-section h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--dark-gray);
      margin-bottom: 12px;
    }

    .client-revenue-table-section table {
      font-size: 13px;
    }

    .client-revenue-table-section th {
      padding: 12px 16px;
      font-size: 11px;
    }

    .client-revenue-table-section td {
      padding: 12px 16px;
    }

    @media (max-width: 900px) {
      .client-revenue-tables {
        grid-template-columns: 1fr;
      }
      
      .client-revenue-totals {
        flex-direction: column;
        gap: 8px;
      }
    }

    /* ===== MOBILE MENU BUTTON ===== */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 1001;
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--white);
      border: none;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 5px;
    }

    .mobile-menu-btn span {
      display: block;
      width: 20px;
      height: 2px;
      background: var(--black);
      border-radius: 2px;
      transition: all 0.3s;
    }

    .mobile-menu-btn.active span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }

    .mobile-menu-btn.active span:nth-child(2) {
      opacity: 0;
    }

    .mobile-menu-btn.active span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .mobile-overlay.active {
      display: block;
      opacity: 1;
    }

    /* ===== RESPONSIVE - TABLET ===== */
    @media (max-width: 1024px) {
      .sidebar {
        width: 80px;
      }

      .sidebar-logo,
      .sidebar-section-title,
      .sidebar-link span,
      .sidebar-user-email {
        display: none;
      }

      .sidebar-link {
        justify-content: center;
        padding: 16px;
      }

      .sidebar-link-icon {
        margin: 0;
      }

      .sidebar-user {
        padding: 12px;
      }

      .sidebar-user-info {
        justify-content: center;
      }

      .logout-btn span:last-child {
        display: none;
      }

      .main-content {
        margin-left: 80px;
      }

      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .project-kanban {
        gap: 16px;
      }

      .project-column {
        min-width: 280px;
      }
    }

    /* ===== RESPONSIVE - MOBILE ===== */
    @media (max-width: 768px) {
      .mobile-menu-btn {
        display: flex;
      }

      .sidebar {
        position: fixed;
        left: -280px;
        width: 280px;
        z-index: 1000;
        transition: left 0.3s ease;
      }

      .sidebar.open {
        left: 0;
      }

      .sidebar-logo,
      .sidebar-section-title,
      .sidebar-link span,
      .sidebar-user-email {
        display: block;
      }

      .sidebar-link {
        justify-content: flex-start;
        padding: 14px 20px;
      }

      .logout-btn span:last-child {
        display: inline;
      }

      .main-content {
        margin-left: 0;
      }

      .header {
        padding: 16px 20px 16px 70px;
        position: sticky;
        top: 0;
        z-index: 100;
        background: var(--off-white);
      }

      .header-title {
        font-size: 18px;
      }

      .container {
        padding: 16px;
      }

      .page-title {
        font-size: 22px;
      }

      .page-subtitle {
        font-size: 13px;
      }

      /* KPI Cards */
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .kpi-card {
        padding: 16px;
      }

      .kpi-value {
        font-size: 24px;
      }

      .kpi-label {
        font-size: 11px;
      }

      /* Charts */
      .charts-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .chart-card {
        padding: 16px;
      }

      .chart-container {
        height: 200px;
      }

      /* Client Grid */
      .client-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .client-card {
        padding: 16px;
      }

      .client-card-icon {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }

      .client-card-name {
        font-size: 12px;
      }

      /* Tables - Horizontal Scroll */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -16px;
        padding: 0 16px;
      }

      .data-table {
        min-width: 600px;
        font-size: 13px;
      }

      .data-table th,
      .data-table td {
        padding: 10px 12px;
        white-space: nowrap;
      }

      /* Filters */
      .filters-row {
        flex-direction: column;
        gap: 10px;
      }

      .filter-select {
        width: 100%;
      }

      /* Kanban Board - Horizontal Scroll */
      .kanban-board {
        flex-direction: row;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 16px;
        margin: 0 -16px;
        padding-left: 16px;
        padding-right: 16px;
      }

      .kanban-column {
        min-width: 280px;
        max-width: 280px;
        flex-shrink: 0;
      }

      /* Project Kanban */
      .project-kanban {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 16px;
        margin: 0 -16px;
        padding-left: 16px;
        padding-right: 16px;
      }

      .project-column {
        min-width: 260px;
        flex-shrink: 0;
      }

      /* Modals - Full Screen on Mobile */
      .modal {
        width: 100%;
        max-width: 100%;
        height: 100%;
        max-height: 100%;
        border-radius: 0;
        margin: 0;
      }

      .modal-body {
        max-height: calc(100vh - 140px);
        overflow-y: auto;
      }

      .modal-header {
        padding: 16px 20px;
        position: sticky;
        top: 0;
        background: var(--white);
        z-index: 10;
      }

      .modal-footer {
        padding: 16px 20px;
        position: sticky;
        bottom: 0;
        background: var(--white);
      }

      /* Form Elements */
      .form-input,
      .form-select,
      .form-textarea {
        font-size: 16px; /* Prevents iOS zoom */
        padding: 14px 16px;
      }

      .btn {
        padding: 14px 20px;
        font-size: 15px;
      }

      /* Profile Page */
      .profile-grid {
        grid-template-columns: 1fr;
      }

      .color-picker-grid {
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
      }

      .team-members-grid {
        grid-template-columns: 1fr;
      }

      /* Task Detail Modal */
      .task-detail-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .task-comments-section {
        margin-top: 20px;
        padding-top: 16px;
      }

      .task-comments-list {
        max-height: 180px;
      }

      .task-comment-input-row {
        flex-direction: column;
        gap: 10px;
      }

      .task-comment-btn {
        width: 100%;
      }

      /* Section Headers */
      .section {
        margin-bottom: 24px;
      }

      .section-title {
        font-size: 16px;
      }

      /* Back Button */
      .back-btn {
        padding: 10px 16px;
        font-size: 13px;
      }

      /* PDF Upload */
      .drop-zone {
        padding: 24px;
      }

      .drop-zone-text {
        font-size: 14px;
      }

      /* Action Buttons in Tables */
      .action-btn {
        padding: 6px 10px;
        font-size: 11px;
      }

      /* Client Revenue Tables */
      .client-revenue-tables {
        grid-template-columns: 1fr;
      }

      /* Dashboard Stats */
      .quick-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      /* Client Selector */
      .client-selector {
        flex-direction: column;
        align-items: stretch;
      }

      .client-select {
        width: 100%;
      }

      /* Notifications */
      .notification-item {
        padding: 16px;
        gap: 12px;
      }

      .notification-icon {
        width: 36px;
        height: 36px;
        font-size: 16px;
      }

      .notification-title {
        font-size: 14px;
      }

      .notification-message {
        font-size: 12px;
      }

      .notification-meta {
        flex-wrap: wrap;
        gap: 8px;
      }

      /* Notification badge on mobile sidebar */
      .notification-badge {
        position: absolute;
        right: 16px;
      }
    }

    /* ===== RESPONSIVE - SMALL PHONES ===== */
    @media (max-width: 480px) {
      .kpi-grid {
        grid-template-columns: 1fr;
      }

      .quick-stats {
        grid-template-columns: 1fr;
      }

      .client-grid {
        grid-template-columns: 1fr;
      }

      .kanban-column {
        min-width: 260px;
      }

      .chart-container {
        height: 180px;
      }

      .task-comment {
        padding: 12px;
      }

      .task-comment-avatar {
        width: 32px;
        height: 32px;
        font-size: 12px;
      }
    }

    /* ===== TOUCH IMPROVEMENTS ===== */
    @media (hover: none) and (pointer: coarse) {
      .sidebar-link,
      .client-card,
      .kanban-card,
      .project-task-card,
      .btn,
      .action-btn {
        -webkit-tap-highlight-color: transparent;
      }

      .client-card:active,
      .kanban-card:active,
      .project-task-card:active {
        transform: scale(0.98);
      }

      /* Larger touch targets */
      .sidebar-link {
        min-height: 48px;
      }

      .action-btn {
        min-height: 36px;
        min-width: 60px;
      }
    }
  </style>
</head>
<body>

<!-- Mobile Menu Button -->
<button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()">
  <span></span>
  <span></span>
  <span></span>
</button>

<!-- Mobile Overlay -->
<div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>

<div class="app-layout">

  <!-- ===== SIDEBAR ===== -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">Watchmaker<span>CRM</span></div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">Main</div>
      <nav class="sidebar-nav">
        <button class="sidebar-link active" onclick="showPage('dashboard')">
          <span class="sidebar-link-icon">ðŸ“Š</span>
          <span>Dashboard</span>
        </button>
        <button class="sidebar-link" onclick="showPage('projects')">
          <span class="sidebar-link-icon">ðŸ“</span>
          <span>Client Projects</span>
        </button>
      </nav>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">Product Management</div>
      <nav class="sidebar-nav">
        <button class="sidebar-link" onclick="showPage('tasks')">
          <span class="sidebar-link-icon">âœ…</span>
          <span>Tasks</span>
        </button>
        <button class="sidebar-link" onclick="showPage('kanban')">
          <span class="sidebar-link-icon">ðŸ“‹</span>
          <span>Progress Board</span>
        </button>
        <button class="sidebar-link" onclick="showPage('reports')">
          <span class="sidebar-link-icon">ðŸ“ˆ</span>
          <span>Reports</span>
        </button>
      </nav>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">Revenue</div>
      <nav class="sidebar-nav">
        <button class="sidebar-link" onclick="showPage('revenue')">
          <span class="sidebar-link-icon">ðŸ’°</span>
          <span>Watchmaker Revenue</span>
        </button>
        <button class="sidebar-link" onclick="showPage('clients')">
          <span class="sidebar-link-icon">ðŸ“Š</span>
          <span>Client Invoices</span>
        </button>
      </nav>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">Account</div>
      <nav class="sidebar-nav">
        <button class="sidebar-link" onclick="showPage('profile')">
          <span class="sidebar-link-icon">ðŸ‘¤</span>
          <span>Profile</span>
        </button>
        <button class="sidebar-link" onclick="showPage('notifications')">
          <span class="sidebar-link-icon">ðŸ””</span>
          <span>Notifications</span>
          <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
        </button>
      </nav>
    </div>

    <!-- User Info & Logout -->
    <div class="sidebar-user">
      <div class="sidebar-user-info">
        <div class="sidebar-user-avatar" id="userAvatar">?</div>
        <div class="sidebar-user-email" id="userEmail">Loading...</div>
      </div>
      <button class="logout-btn" onclick="handleLogout()">
        <span>ðŸšª</span>
        <span>Sign Out</span>
      </button>
    </div>
  </aside>

  <!-- ===== MAIN CONTENT ===== -->
  <main class="main-content">

    <!-- ===== PAGE: DASHBOARD ===== -->
    <div id="page-dashboard" class="page">
      <header class="header">
        <div class="header-title">Dashboard</div>
      </header>
      <div class="container">
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle">Quick overview of your clients and projects</p>

        <!-- QUICK STATS -->
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-label">Total Clients</div>
            <div class="kpi-value" id="kpiTotalClients">7</div>
          </div>
          <div class="kpi-card highlight">
            <div class="kpi-label">Active Projects</div>
            <div class="kpi-value" id="kpiActiveProjects">0</div>
          </div>
          <div class="kpi-card purple">
            <div class="kpi-label">Open Tasks</div>
            <div class="kpi-value" id="kpiOpenTasks">0</div>
          </div>
          <div class="kpi-card green">
            <div class="kpi-label">Completed This Week</div>
            <div class="kpi-value" id="kpiCompletedWeek">0</div>
          </div>
        </div>

        <!-- CLIENTS QUICK ACCESS -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">Clients</h2>
            <button class="btn btn-primary btn-sm" onclick="showPage('projects')">View All Projects â†’</button>
          </div>
          <div class="client-grid" id="clientGrid"></div>
        </section>
      </div>
    </div>

    <!-- ===== PAGE: CLIENT PROJECTS ===== -->
    <div id="page-projects" class="page hidden">
      <header class="header">
        <div class="header-title">Client Projects</div>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="openProjectModal()">+ New Project</button>
        </div>
      </header>
      <div class="container">
        <h1 class="page-title">Client Projects</h1>
        <p class="page-subtitle">Manage projects and tasks for each client</p>

        <!-- CLIENT SELECTOR -->
        <div class="client-selector" id="clientSelector">
          <!-- JS will populate -->
        </div>

        <!-- PROJECT KANBAN BOARD -->
        <div class="project-kanban-board" id="projectKanbanBoard">
          <!-- JS will populate -->
        </div>
      </div>
    </div>

    <!-- ===== PAGE: REVENUE (Watchmaker) ===== -->
    <div id="page-revenue" class="page hidden">
      <header class="header">
        <div class="header-title">Watchmaker Revenue</div>
      </header>
      <div class="container">
        <h1 class="page-title">Watchmaker Revenue</h1>
        <p class="page-subtitle">Overall revenue tracking and analytics</p>

        <!-- KPI CARDS -->
        <div class="kpi-grid" id="kpiGrid">
          <div class="kpi-card">
            <div class="kpi-label">Total Gross Revenue</div>
            <div class="kpi-value" id="kpiTotalGross">$0</div>
          </div>
          <div class="kpi-card highlight">
            <div class="kpi-label">Watchmaker Revenue (15%)</div>
            <div class="kpi-value" id="kpiWatchmaker">$0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Total Invoices</div>
            <div class="kpi-value" id="kpiInvoiceCount">0</div>
          </div>
        </div>

        <!-- CHARTS -->
        <div class="charts-grid">
          <div class="chart-card">
            <div class="chart-title">Monthly Gross Revenue</div>
            <div class="chart-container">
              <canvas id="grossChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-title">Watchmaker Revenue (15% of Gross)</div>
            <div class="chart-container">
              <canvas id="watchmakerChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PAGE: CLIENT INVOICES LIST ===== -->
    <div id="page-clients" class="page hidden">
      <header class="header">
        <div class="header-title">Client Invoices</div>
      </header>
      <div class="container">
        <h1 class="page-title">Client Invoices</h1>
        <p class="page-subtitle">View client revenue breakdowns and upload invoices</p>

        <!-- CLIENT CARDS -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">Select Client</h2>
          </div>
          <div class="client-grid" id="clientInvoicesGrid">
            <!-- JS will populate -->
          </div>
        </section>

        <!-- UPLOAD -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">Upload Invoice</h2>
          </div>
          <div class="upload-card">
            <div id="drop-zone" class="drop-zone">
              <div class="drop-zone-icon">ðŸ“„</div>
              <div class="drop-zone-text">Drop PDF invoices here</div>
              <div class="drop-zone-hint">or click to browse files</div>
            </div>
            <input id="file-input" type="file" accept="application/pdf" multiple style="display:none;" />
            <div id="status"></div>
          </div>
        </section>

        <!-- JSON OUTPUT -->
        <section class="section">
          <div class="json-card">
            <div class="json-title">Raw JSON Response</div>
            <pre id="rawJson">// Parsed invoice JSON will appear here.</pre>
          </div>
        </section>
      </div>
    </div>

    <!-- ===== PAGE: CLIENT DETAIL ===== -->
    <div id="page-client" class="page hidden">
      <header class="header">
        <div class="header-title" id="clientHeaderTitle">Client</div>
      </header>
      <div class="container">
        <button class="back-btn" onclick="showPage('clients')">â† Back to Clients</button>
        <h1 class="page-title" id="clientTitle"></h1>
        <p class="page-subtitle">Invoice history and revenue breakdown</p>

        <!-- CLIENT KPIs -->
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-label">Client Total Gross</div>
            <div class="kpi-value" id="clientTotalGross">$0</div>
          </div>
          <div class="kpi-card highlight">
            <div class="kpi-label">Watchmaker Revenue (15%)</div>
            <div class="kpi-value" id="clientWatchmaker">$0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Invoices</div>
            <div class="kpi-value" id="clientInvoiceCount">0</div>
          </div>
        </div>

        <!-- INVOICES TABLE -->
        <section class="section">
          <h2 class="section-title">Invoices</h2>
          <div class="table-card">
            <div id="clientInvoices"></div>
          </div>
        </section>

        <!-- MONTHLY TABLE -->
        <section class="section">
          <h2 class="section-title">Monthly Revenue</h2>
          <div class="table-card">
            <div id="clientMonthlyTable"></div>
          </div>
        </section>

        <!-- CLIENT CHART -->
        <section class="section">
          <h2 class="section-title">Revenue Trend</h2>
          <div class="chart-card">
            <div class="chart-container">
              <canvas id="clientChart"></canvas>
            </div>
          </div>
        </section>

        <!-- CLIENT TASKS -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">Client Tasks</h2>
            <button class="btn btn-primary btn-sm" onclick="openTaskModalForClient()">+ New Task</button>
          </div>
          <div class="table-card">
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Priority</th>
                  <th>Status</th>
                  <th>Due Date</th>
                  <th>Assigned To</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="clientTasksTableBody">
                <!-- JS will populate -->
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>

    <!-- ===== PAGE: TASKS ===== -->
    <div id="page-tasks" class="page hidden">
      <header class="header">
        <div class="header-title">Product Management â€” Task List</div>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="openTaskModal()">+ New Task</button>
        </div>
      </header>
      <div class="container">
        <h1 class="page-title">Tasks</h1>
        <p class="page-subtitle">Manage your product tasks and assignments</p>

        <!-- TASK TABS -->
        <div class="task-tabs">
          <button class="task-tab active" id="tabAllTasks" onclick="switchTaskTab('all')">
            All Tasks
          </button>
          <button class="task-tab" id="tabMyTasks" onclick="switchTaskTab('my')">
            My Tasks <span class="my-tasks-count" id="myTasksCount">0</span>
          </button>
        </div>

        <!-- FILTERS -->
        <div class="filters-row">
          <select class="filter-select" id="filterClient" onchange="loadTasks()">
            <option value="">All Clients</option>
            <option value="Warrior Injury Law">Warrior Injury Law</option>
            <option value="Haselwood Auto Group">Haselwood Auto Group</option>
            <option value="Core Contractors">Core Contractors</option>
            <option value="Bob Oates">Bob Oates</option>
            <option value="Scuttlebutt Brewing">Scuttlebutt Brewing</option>
            <option value="Bayside Coin & Jewelry">Bayside Coin & Jewelry</option>
            <option value="Hunt's Services">Hunt's Services</option>
            <option value="Emerald City Smoothie">Emerald City Smoothie</option>
          </select>
          <select class="filter-select" id="filterPriority" onchange="loadTasks()">
            <option value="">All Priorities</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
          </select>
          <select class="filter-select" id="filterStatus" onchange="loadTasks()">
            <option value="">All Statuses</option>
            <option value="todo">To Do</option>
            <option value="in_progress">In Progress</option>
            <option value="review">Review</option>
            <option value="done">Done</option>
            <option value="archived">ðŸ“¦ Archived</option>
          </select>
        </div>

        <!-- TASKS TABLE -->
        <div class="table-card">
          <table>
            <thead>
              <tr>
                <th>Title</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Due Date</th>
                <th>Assigned To</th>
                <th>Client</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tasksTableBody">
              <!-- JS will populate -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== PAGE: KANBAN (Progress Board) ===== -->
    <div id="page-kanban" class="page hidden">
      <header class="header">
        <div class="header-title">Progress Board</div>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="openTaskModal()">+ New Task</button>
        </div>
      </header>
      <div class="container">
        <h1 class="page-title">Progress Board</h1>
        <p class="page-subtitle">Drag and drop tasks to update their status</p>

        <div class="kanban-board" id="kanbanBoard">
          <div class="kanban-column" data-status="todo">
            <div class="kanban-column-header">
              <span class="kanban-column-title">To Do</span>
              <span class="kanban-column-count" id="count-todo">0</span>
            </div>
            <div class="kanban-cards" id="kanban-todo"></div>
          </div>
          <div class="kanban-column" data-status="in_progress">
            <div class="kanban-column-header">
              <span class="kanban-column-title">In Progress</span>
              <span class="kanban-column-count" id="count-in_progress">0</span>
            </div>
            <div class="kanban-cards" id="kanban-in_progress"></div>
          </div>
          <div class="kanban-column" data-status="review">
            <div class="kanban-column-header">
              <span class="kanban-column-title">Review</span>
              <span class="kanban-column-count" id="count-review">0</span>
            </div>
            <div class="kanban-cards" id="kanban-review"></div>
          </div>
          <div class="kanban-column" data-status="done">
            <div class="kanban-column-header">
              <span class="kanban-column-title">Done</span>
              <span class="kanban-column-count" id="count-done">0</span>
            </div>
            <div class="kanban-cards" id="kanban-done"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PAGE: REPORTS ===== -->
    <div id="page-reports" class="page hidden">
      <header class="header">
        <div class="header-title">Reports</div>
      </header>
      <div class="container">
        <h1 class="page-title">Reports</h1>
        <p class="page-subtitle">Task analytics and performance metrics</p>

        <!-- REPORT KPIs -->
        <div class="kpi-grid">
          <div class="kpi-card green">
            <div class="kpi-label">Completed This Week</div>
            <div class="kpi-value" id="reportCompletedWeek">0</div>
          </div>
          <div class="kpi-card red">
            <div class="kpi-label">Overdue Tasks</div>
            <div class="kpi-value" id="reportOverdue">0</div>
          </div>
          <div class="kpi-card purple">
            <div class="kpi-label">High Priority</div>
            <div class="kpi-value" id="reportHighPriority">0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Total Tasks</div>
            <div class="kpi-value" id="reportTotal">0</div>
          </div>
        </div>

        <!-- REPORT CHARTS -->
        <div class="charts-grid">
          <div class="chart-card">
            <div class="chart-title">Tasks Completed Per Week</div>
            <div class="chart-container">
              <canvas id="tasksPerWeekChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-title">Priority Distribution</div>
            <div class="chart-container">
              <canvas id="priorityChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PAGE: PROFILE ===== -->
    <div id="page-profile" class="page hidden">
      <header class="header">
        <div class="header-title">Profile Settings</div>
      </header>
      <div class="container">
        <h1 class="page-title">Your Profile</h1>
        <p class="page-subtitle">Manage your account settings and appearance</p>

        <div class="profile-grid">
          <!-- Profile Info Card -->
          <div class="profile-card">
            <h3 class="profile-card-title">Profile Information</h3>
            <div class="form-group">
              <label class="form-label">Email Address</label>
              <input type="email" class="form-input" id="profileEmail" disabled>
            </div>
            <div class="form-group">
              <label class="form-label">Display Name</label>
              <input type="text" class="form-input" id="profileDisplayName" placeholder="Your name">
            </div>
            <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
            <div id="profileMessage" class="profile-message"></div>
          </div>

          <!-- Color Selection Card -->
          <div class="profile-card">
            <h3 class="profile-card-title">Your Color</h3>
            <p class="profile-card-subtitle">Choose a color that will appear next to your name when assigned to tasks. Once chosen, this color is reserved for you.</p>
            <div class="color-picker-grid" id="colorPickerGrid">
              <!-- JS will populate -->
            </div>
            <div id="colorMessage" class="profile-message"></div>
          </div>
        </div>

        <!-- Team Colors Preview -->
        <section class="section">
          <h2 class="section-title">Team Members</h2>
          <div class="team-members-grid" id="teamMembersGrid">
            <!-- JS will populate -->
          </div>
        </section>
      </div>
    </div>

    <!-- ===== PAGE: NOTIFICATIONS ===== -->
    <div id="page-notifications" class="page hidden">
      <header class="header">
        <div class="header-title">Notifications</div>
      </header>
      <div class="container">
        <h1 class="page-title">Notifications</h1>
        <p class="page-subtitle">Stay updated on tasks assigned to you</p>

        <div class="notifications-actions">
          <button class="btn btn-outline" onclick="markAllNotificationsRead()">Mark All as Read</button>
        </div>

        <div class="notifications-list" id="notificationsList">
          <!-- JS will populate -->
        </div>
      </div>
    </div>

  </main>
</div>

<!-- ===== TASK MODAL ===== -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title" id="taskModalTitle">New Task</h3>
      <button class="modal-close" onclick="closeTaskModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="taskId">
      <div class="form-group">
        <label class="form-label">Title *</label>
        <input type="text" class="form-input" id="taskTitle" required>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="taskDescription"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Priority</label>
        <select class="form-select" id="taskPriority">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
          <option value="urgent">Urgent</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select class="form-select" id="taskStatus">
          <option value="todo" selected>To Do</option>
          <option value="in_progress">In Progress</option>
          <option value="review">Review</option>
          <option value="done">Done</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Due Date</label>
        <input type="date" class="form-input" id="taskDueDate">
      </div>
      <div class="form-group">
        <label class="form-label">Client</label>
        <select class="form-select" id="taskClient">
          <option value="">â€” No Client â€”</option>
          <option value="Warrior Injury Law">Warrior Injury Law</option>
          <option value="Haselwood Auto Group">Haselwood Auto Group</option>
          <option value="Core Contractors">Core Contractors</option>
          <option value="Bob Oates">Bob Oates</option>
          <option value="Scuttlebutt Brewing">Scuttlebutt Brewing</option>
          <option value="Bayside Coin & Jewelry">Bayside Coin & Jewelry</option>
          <option value="Hunt's Services">Hunt's Services</option>
          <option value="Emerald City Smoothie">Emerald City Smoothie</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Assign To</label>
        <select class="form-select" id="taskAssignedTo">
          <option value="">â€” Unassigned â€”</option>
          <!-- JS will populate with team members -->
        </select>
      </div>
      <div class="checkbox-group">
        <input type="checkbox" class="checkbox-input" id="taskPrivate">
        <label class="checkbox-label" for="taskPrivate">
          <span class="lock-icon">ðŸ”’</span> Private task (only visible to you)
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeTaskModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
    </div>
  </div>
</div>

<!-- ===== TASK DETAIL MODAL ===== -->
<div class="modal-overlay" id="taskDetailModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title" id="taskDetailTitle">Task Details</h3>
      <button class="modal-close" onclick="closeTaskDetailModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="task-detail-badges" id="taskDetailBadges"></div>
      <div class="task-detail-section">
        <div class="task-detail-label">Description</div>
        <div class="task-detail-value" id="taskDetailDescription">No description provided.</div>
      </div>
      <div class="task-detail-grid">
        <div class="task-detail-item">
          <div class="task-detail-label">Due Date</div>
          <div class="task-detail-value" id="taskDetailDueDate">â€”</div>
        </div>
        <div class="task-detail-item">
          <div class="task-detail-label">Assigned To</div>
          <div class="task-detail-value" id="taskDetailAssignedTo">â€”</div>
        </div>
        <div class="task-detail-item">
          <div class="task-detail-label">Client</div>
          <div class="task-detail-value" id="taskDetailClient">â€”</div>
        </div>
        <div class="task-detail-item">
          <div class="task-detail-label">Created</div>
          <div class="task-detail-value" id="taskDetailCreated">â€”</div>
        </div>
      </div>

      <!-- Comments Section -->
      <div class="task-comments-section">
        <div class="task-comments-title">
          ðŸ’¬ Comments <span class="comment-count" id="commentCount">0</span>
        </div>
        <div class="task-comments-list" id="taskCommentsList">
          <!-- JS will populate -->
        </div>
        <div class="task-comment-input-row" style="position: relative;">
          <input type="text" class="task-comment-input" id="taskCommentInput" placeholder="Write a comment... Use @name to mention someone">
          <div id="mentionAutocomplete" class="mention-autocomplete hidden"></div>
          <button class="task-comment-btn" id="postCommentBtn" onclick="addTaskComment()">
            <span id="postCommentText">Post</span>
          </button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeTaskDetailModal()">Close</button>
      <button class="btn btn-primary" id="taskDetailEditBtn" onclick="editTaskFromDetail()">Edit Task</button>
    </div>
  </div>
</div>

<!-- ===== PROJECT MODAL ===== -->
<div class="modal-overlay" id="projectModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title" id="projectModalTitle">New Project</h3>
      <button class="modal-close" onclick="closeProjectModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="projectId">
      <div class="form-group">
        <label class="form-label">Project Name *</label>
        <input type="text" class="form-input" id="projectName" placeholder="e.g., Q1 Branding Campaign" required>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="projectDescription" placeholder="Brief description of the project..."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Client *</label>
        <select class="form-select" id="projectClient" required>
          <option value="">â€” Select Client â€”</option>
          <option value="Warrior Injury Law">Warrior Injury Law</option>
          <option value="Haselwood Auto Group">Haselwood Auto Group</option>
          <option value="Core Contractors">Core Contractors</option>
          <option value="Bob Oates">Bob Oates</option>
          <option value="Scuttlebutt Brewing">Scuttlebutt Brewing</option>
          <option value="Bayside Coin & Jewelry">Bayside Coin & Jewelry</option>
          <option value="Hunt's Services">Hunt's Services</option>
          <option value="Emerald City Smoothie">Emerald City Smoothie</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeProjectModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveProject()">Save Project</button>
    </div>
  </div>
</div>

<!-- ===== PROJECT TASK MODAL ===== -->
<div class="modal-overlay" id="projectTaskModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title" id="projectTaskModalTitle">Add Task to Project</h3>
      <button class="modal-close" onclick="closeProjectTaskModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="projectTaskId">
      <input type="hidden" id="projectTaskProjectId">
      <div class="form-group">
        <label class="form-label">Title *</label>
        <input type="text" class="form-input" id="projectTaskTitle" required>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="projectTaskDescription"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Priority</label>
        <select class="form-select" id="projectTaskPriority">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
          <option value="urgent">Urgent</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select class="form-select" id="projectTaskStatus">
          <option value="todo" selected>To Do</option>
          <option value="in_progress">In Progress</option>
          <option value="review">Review</option>
          <option value="done">Done</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Due Date</label>
        <input type="date" class="form-input" id="projectTaskDueDate">
      </div>
      <div class="form-group">
        <label class="form-label">Assigned To</label>
        <select class="form-select" id="projectTaskAssignedTo">
          <option value="">â€” Unassigned â€”</option>
          <!-- JS will populate with team members -->
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeProjectTaskModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveProjectTask()">Save Task</button>
    </div>
  </div>
</div>

<style>
  .task-detail-badges {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  .task-detail-section {
    margin-bottom: 24px;
  }
  .task-detail-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--medium-gray);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  .task-detail-value {
    font-size: 15px;
    color: var(--black);
    line-height: 1.6;
  }
  .task-detail-value.description {
    background: var(--off-white);
    padding: 16px;
    border-radius: var(--radius);
    white-space: pre-wrap;
    min-height: 60px;
  }
  .task-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  .task-detail-item {
    background: var(--off-white);
    padding: 14px 16px;
    border-radius: var(--radius);
  }
  .task-row-clickable {
    cursor: pointer;
  }
  .task-row-clickable:hover td {
    background: var(--off-white);
  }
</style>

<script>
/* ================================
   CONFIG
================================ */
const FUNCTION_URL = "https://cagajzhridvohsrviwaw.supabase.co/functions/v1/quick-task";
const SUPABASE_URL = "https://cagajzhridvohsrviwaw.supabase.co/rest/v1";
const SUPABASE_BASE_URL = "https://cagajzhridvohsrviwaw.supabase.co";
const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhZ2FqemhyaWR2b2hzcnZpd2F3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyODQ0ODYsImV4cCI6MjA3OTg2MDQ4Nn0.CSZvT7tPgoEyXwUW_wLOzZUfSUPLAZMpbXvvLOn5cNo";

// Initialize Supabase Auth Client
const supabaseAuth = window.supabase.createClient(SUPABASE_BASE_URL, ANON_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
  },
});

// Global access token - updated on login
let ACCESS_TOKEN = ANON_KEY;

// Helper function to get auth headers with user's session token
function getAuthHeaders() {
  return {
    apikey: ANON_KEY,
    Authorization: "Bearer " + ACCESS_TOKEN
  };
}

const CLIENTS = [
  { name: "Warrior Injury Law", filter: "Warrior", hasInvoices: true },
  { name: "Haselwood Auto Group", filter: "Haselwood", hasInvoices: true },
  { name: "Core Contractors", filter: "Core", hasInvoices: true },
  { name: "Bob Oates", filter: "Bob Oates", hasInvoices: true },
  { name: "Scuttlebutt Brewing", filter: "Scuttlebutt", hasInvoices: true },
  { name: "Bayside Coin & Jewelry", filter: "Bayside", hasInvoices: true },
  { name: "Hunt's Services", filter: "Hunt", hasInvoices: true },
  { name: "Emerald City Smoothie", filter: "Emerald", hasInvoices: false }
];

// 10 user colors available for profiles
const USER_COLORS = [
  { id: "coral", name: "Coral", hex: "#FF6B6B" },
  { id: "orange", name: "Orange", hex: "#FF9F43" },
  { id: "gold", name: "Gold", hex: "#FECA57" },
  { id: "lime", name: "Lime", hex: "#1DD1A1" },
  { id: "teal", name: "Teal", hex: "#00D2D3" },
  { id: "sky", name: "Sky Blue", hex: "#54A0FF" },
  { id: "purple", name: "Purple", hex: "#5F27CD" },
  { id: "pink", name: "Pink", hex: "#FF6B81" },
  { id: "slate", name: "Slate", hex: "#576574" },
  { id: "indigo", name: "Indigo", hex: "#341F97" }
];

// Current user profile data
let currentUserProfile = null;
let allUserProfiles = [];

// Helper: determine if an invoice is from Lamar (exclude from 15% calc)
function isLamarInvoice(inv) {
  const company = (inv.company_name || "").toLowerCase();
  const station = (inv.station_name || "").toLowerCase();
  return company.includes("lamar") || station.includes("lamar");
}

/* ================================
   PAGE NAVIGATION
================================ */
let currentPage = 'dashboard';

function showPage(pageName) {
  // Hide all pages
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  
  // Show target page
  const targetPage = document.getElementById('page-' + pageName);
  if (targetPage) {
    targetPage.classList.remove('hidden');
  }
  
  // Update sidebar active state
  document.querySelectorAll('.sidebar-link').forEach(link => {
    link.classList.remove('active');
    if (link.getAttribute('onclick')?.includes(pageName)) {
      link.classList.add('active');
    }
  });
  
  currentPage = pageName;
  
  // Load page-specific data
  if (pageName === 'dashboard') {
    loadDashboardStats();
  } else if (pageName === 'projects') {
    loadProjectsPage();
  } else if (pageName === 'revenue') {
    loadRevenueKPIs();
  } else if (pageName === 'clients') {
    renderClientInvoicesGrid();
    setupPdfUpload();
  } else if (pageName === 'tasks') {
    loadTasks();
  } else if (pageName === 'kanban') {
    loadKanban();
  } else if (pageName === 'reports') {
    loadReports();
  } else if (pageName === 'profile') {
    loadProfile();
  } else if (pageName === 'notifications') {
    loadNotifications();
  }
}

/* ================================
   MOBILE MENU
================================ */
function toggleMobileMenu() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('mobileOverlay');
  const btn = document.getElementById('mobileMenuBtn');
  
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
  btn.classList.toggle('active');
}

function closeMobileMenu() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('mobileOverlay');
  const btn = document.getElementById('mobileMenuBtn');
  
  sidebar.classList.remove('open');
  overlay.classList.remove('active');
  btn.classList.remove('active');
}

// Close mobile menu when clicking a nav link
document.querySelectorAll('.sidebar-link').forEach(link => {
  link.addEventListener('click', () => {
    if (window.innerWidth <= 768) {
      closeMobileMenu();
    }
  });
});

// Close mobile menu on window resize to desktop
window.addEventListener('resize', () => {
  if (window.innerWidth > 768) {
    closeMobileMenu();
  }
});

/* ================================
   INIT
================================ */
window.addEventListener("DOMContentLoaded", async () => {
  // Session Guard - Check if user is logged in
  const { data: { session } } = await supabaseAuth.auth.getSession();
  
  if (!session) {
    // Not logged in - redirect to login page
    window.location.href = "login.html";
    return;
  }
  
  // Store current user session
  window.currentSession = session;
  
  // Update global access token for API calls
  ACCESS_TOKEN = session.access_token;
  
  // Ensure current user has a profile with email
  await ensureUserProfile(session.user);
  
  // Load all user profiles (for colors and team display)
  await loadAllUserProfiles();
  
  // User is logged in - display user info with color
  const userEmail = session.user.email || "User";
  const displayName = session.user.user_metadata?.display_name || userEmail;
  const userInitial = displayName.charAt(0).toUpperCase();
  
  // Get user's color from profile
  const userProfile = allUserProfiles.find(p => p.id === session.user.id);
  const userColor = userProfile?.color ? USER_COLORS.find(c => c.id === userProfile.color)?.hex : '#6B6B6B';
  
  document.getElementById("userAvatar").textContent = userInitial;
  document.getElementById("userAvatar").style.background = userColor;
  document.getElementById("userEmail").textContent = displayName;
  document.getElementById("userEmail").title = userEmail; // Show email on hover
  
  // Initialize dashboard
  renderClientGrid();
  loadDashboardStats();
  
  // Populate assigned to dropdowns
  populateAssignedToDropdowns();
  
  // Start notification system
  startNotificationPolling();
  
  // Setup real-time subscriptions for live updates
  setupRealtimeSubscriptions();
  
});

/* ================================
   LOGOUT
================================ */
async function handleLogout() {
  try {
    await supabaseAuth.auth.signOut();
    window.location.href = "login.html";
  } catch (error) {
    console.error("Logout error:", error);
    alert("Error signing out. Please try again.");
  }
}

function renderClientGrid() {
  const grid = document.getElementById("clientGrid");
  grid.innerHTML = CLIENTS.map(c => {
    // Escape apostrophes in names for onclick handler
    const safeName = c.name.replace(/'/g, "\\'");
    return `
    <div class="client-card" onclick="openClient('${safeName}', '${c.filter}')">
      <div class="client-card-icon">${c.name.charAt(0)}</div>
      <div class="client-card-name">${c.name}</div>
    </div>
  `;
  }).join("");
}

/* ================================
   DASHBOARD STATS
================================ */
async function loadDashboardStats() {
  // Load projects count
  const projectsRes = await fetch(`${SUPABASE_URL}/projects?select=id`, {
    headers: getAuthHeaders()
  });
  const projects = projectsRes.ok ? await projectsRes.json() : [];
  
  // Load tasks
  const tasksRes = await fetch(`${SUPABASE_URL}/tasks?select=*`, {
    headers: getAuthHeaders()
  });
  const tasks = tasksRes.ok ? await tasksRes.json() : [];
  
  // Calculate stats
  const openTasks = tasks.filter(t => t.status !== 'done').length;
  const today = new Date();
  const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
  const completedThisWeek = tasks.filter(t => {
    if (t.status !== 'done') return false;
    const updated = new Date(t.updated_at);
    return updated >= weekAgo;
  }).length;
  
  document.getElementById("kpiTotalClients").textContent = CLIENTS.length;
  document.getElementById("kpiActiveProjects").textContent = projects.length;
  document.getElementById("kpiOpenTasks").textContent = openTasks;
  document.getElementById("kpiCompletedWeek").textContent = completedThisWeek;
}

function selectClientForProjects(clientName) {
  selectedClient = clientName;
  showPage('projects');
}

/* ================================
   PROJECTS PAGE
================================ */
let selectedClient = null;
let allProjects = [];
let projectTasks = {};

async function loadProjectsPage() {
  renderClientSelector();
  await loadProjects();
}

function renderClientSelector() {
  const selector = document.getElementById("clientSelector");
  selector.innerHTML = `
    <button class="client-selector-btn ${!selectedClient ? 'active' : ''}" onclick="filterByClient(null)">
      All Clients
    </button>
    ${CLIENTS.map(c => `
      <button class="client-selector-btn ${selectedClient === c.name ? 'active' : ''}" onclick="filterByClient('${c.name}')">
        ${c.name}
      </button>
    `).join("")}
  `;
}

function filterByClient(clientName) {
  selectedClient = clientName;
  renderClientSelector();
  renderProjectKanban();
}

async function loadProjects() {
  let url = `${SUPABASE_URL}/projects?select=*&order=created_at.desc`;
  if (selectedClient) {
    url += `&client_name=eq.${encodeURIComponent(selectedClient)}`;
  }
  
  const res = await fetch(url, {
    headers: getAuthHeaders()
  });
  
  if (!res.ok) {
    console.error("Failed to load projects");
    allProjects = [];
    renderProjectKanban();
    return;
  }
  
  allProjects = await res.json();
  
  // Load tasks for each project
  for (const project of allProjects) {
    await loadProjectTasks(project.id);
  }
  
  renderProjectKanban();
}

async function loadProjectTasks(projectId) {
  const res = await fetch(`${SUPABASE_URL}/tasks?select=*&project_id=eq.${projectId}&order=created_at.desc`, {
    headers: getAuthHeaders()
  });
  
  if (res.ok) {
    projectTasks[projectId] = await res.json();
  } else {
    projectTasks[projectId] = [];
  }
}

function renderProjectKanban() {
  const board = document.getElementById("projectKanbanBoard");
  
  // Filter projects by selected client
  let displayProjects = selectedClient 
    ? allProjects.filter(p => p.client_name === selectedClient)
    : allProjects;
  
  if (displayProjects.length === 0) {
    board.innerHTML = `
      <div class="project-empty-state">
        <div class="project-empty-icon">ðŸ“</div>
        <div class="project-empty-title">${selectedClient ? `No projects for ${selectedClient}` : 'No projects yet'}</div>
        <div class="project-empty-text">Create your first project to start organizing tasks</div>
        <button class="btn btn-primary" onclick="openProjectModal()">+ Create Project</button>
      </div>
    `;
    return;
  }
  
  board.innerHTML = displayProjects.map(project => {
    const tasks = projectTasks[project.id] || [];
    const today = new Date();
    
    return `
      <div class="project-column" data-project-id="${project.id}">
        <div class="project-column-header">
          <div>
            <div class="project-column-title">${project.project_name}</div>
            <div style="font-size: 11px; color: var(--medium-gray); margin-top: 4px;">${project.client_name}</div>
          </div>
          <div class="project-column-actions">
            <span class="project-column-count">${tasks.length}</span>
            <button class="project-action-btn delete" onclick="deleteProject('${project.id}')" title="Delete project">ðŸ—‘ï¸</button>
          </div>
        </div>
        <div class="project-column-body" 
             data-project-id="${project.id}"
             ondragover="projectDragOver(event)" 
             ondrop="projectDrop(event, '${project.id}')"
             ondragleave="projectDragLeave(event)">
          ${tasks.map(task => {
            const isOverdue = task.due_date && new Date(task.due_date) < today && task.status !== 'done';
            return `
              <div class="project-task-card priority-${task.priority}" 
                   draggable="true" 
                   data-task-id="${task.id}"
                   ondragstart="projectTaskDragStart(event)"
                   ondragend="projectTaskDragEnd(event)"
                   onclick="openProjectTaskForEdit('${task.id}', '${project.id}')">
                <div class="project-task-title">${task.title}</div>
                <div class="project-task-meta">
                  <span class="badge badge-${task.status}">${task.status?.replace('_', ' ')}</span>
                  ${task.due_date ? `<span class="project-task-due ${isOverdue ? 'overdue' : ''}">${task.due_date}</span>` : ''}
                </div>
                ${task.assigned_to ? `<div class="project-task-assignee">${renderAssignedBadge(task.assigned_to)}</div>` : ''}
              </div>
            `;
          }).join("")}
          <button class="add-task-btn" onclick="openProjectTaskModal('${project.id}')">+ Add Task</button>
        </div>
      </div>
    `;
  }).join("") + `
    <div class="add-project-column" onclick="openProjectModal()">
      <div class="add-project-text">+ Add Project</div>
    </div>
  `;
}

/* ================================
   PROJECT DRAG & DROP
================================ */
let draggedTaskId = null;
let draggedFromProjectId = null;

function projectTaskDragStart(e) {
  e.target.classList.add('dragging');
  draggedTaskId = e.target.dataset.taskId;
  draggedFromProjectId = e.target.closest('.project-column')?.dataset.projectId;
  e.dataTransfer.setData('text/plain', draggedTaskId);
  e.dataTransfer.effectAllowed = 'move';
}

function projectTaskDragEnd(e) {
  e.target.classList.remove('dragging');
  draggedTaskId = null;
  draggedFromProjectId = null;
  document.querySelectorAll('.project-column-body').forEach(col => {
    col.classList.remove('drag-over');
  });
}

function projectDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.classList.add('drag-over');
}

function projectDragLeave(e) {
  e.currentTarget.classList.remove('drag-over');
}

async function projectDrop(e, newProjectId) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  
  const taskId = e.dataTransfer.getData('text/plain');
  if (!taskId || !newProjectId) return;
  
  // Don't do anything if dropped in same project
  if (draggedFromProjectId === newProjectId) return;
  
  try {
    // Update task's project_id
    const res = await fetch(`${SUPABASE_URL}/tasks?id=eq.${taskId}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        apikey: ANON_KEY,
        Authorization: "Bearer " + ACCESS_TOKEN,
        Prefer: "return=representation"
      },
      body: JSON.stringify({ project_id: newProjectId })
    });
    
    if (!res.ok) {
      console.error("Failed to move task");
      return;
    }
    
    // Reload projects
    await loadProjects();
  } catch (err) {
    console.error("Error moving task:", err);
  }
}

/* ================================
   PROJECT MODAL
================================ */
function openProjectModal(projectId = null) {
  const modal = document.getElementById("projectModal");
  const title = document.getElementById("projectModalTitle");
  
  // Reset form
  document.getElementById("projectId").value = "";
  document.getElementById("projectName").value = "";
  document.getElementById("projectDescription").value = "";
  document.getElementById("projectClient").value = selectedClient || "";
  
  if (projectId) {
    title.textContent = "Edit Project";
    const project = allProjects.find(p => p.id === projectId);
    if (project) {
      document.getElementById("projectId").value = project.id;
      document.getElementById("projectName").value = project.project_name || "";
      document.getElementById("projectDescription").value = project.description || "";
      document.getElementById("projectClient").value = project.client_name || "";
    }
  } else {
    title.textContent = "New Project";
  }
  
  modal.classList.add("active");
}

function closeProjectModal() {
  document.getElementById("projectModal").classList.remove("active");
}

async function saveProject() {
  const id = document.getElementById("projectId").value;
  const projectName = document.getElementById("projectName").value.trim();
  const clientName = document.getElementById("projectClient").value;
  
  if (!projectName) {
    alert("Project name is required");
    return;
  }
  
  if (!clientName) {
    alert("Please select a client");
    return;
  }
  
  const projectData = {
    project_name: projectName,
    description: document.getElementById("projectDescription").value.trim(),
    client_name: clientName
  };
  
  try {
    if (id) {
      // Update existing project
      const res = await fetch(`${SUPABASE_URL}/projects?id=eq.${id}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          apikey: ANON_KEY,
          Authorization: "Bearer " + ACCESS_TOKEN,
          Prefer: "return=representation"
        },
        body: JSON.stringify(projectData)
      });
      
      if (!res.ok) throw new Error("Failed to update project");
    } else {
      // Create new project
      const res = await fetch(`${SUPABASE_URL}/projects`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: ANON_KEY,
          Authorization: "Bearer " + ACCESS_TOKEN,
          Prefer: "return=representation"
        },
        body: JSON.stringify(projectData)
      });
      
      if (!res.ok) throw new Error("Failed to create project");
    }
    
    closeProjectModal();
    await loadProjects();
  } catch (err) {
    alert("Error saving project: " + err.message);
  }
}

async function deleteProject(projectId) {
  if (!confirm("Delete this project? All tasks in this project will be unlinked.")) return;
  
  try {
    // First, unlink all tasks from this project
    await fetch(`${SUPABASE_URL}/tasks?project_id=eq.${projectId}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        apikey: ANON_KEY,
        Authorization: "Bearer " + ACCESS_TOKEN
      },
      body: JSON.stringify({ project_id: null })
    });
    
    // Then delete the project
    const res = await fetch(`${SUPABASE_URL}/projects?id=eq.${projectId}`, {
      method: "DELETE",
      headers: {
        apikey: ANON_KEY,
        Authorization: "Bearer " + ACCESS_TOKEN
      }
    });
    
    if (!res.ok) throw new Error("Failed to delete project");
    
    await loadProjects();
  } catch (err) {
    alert("Error deleting project: " + err.message);
  }
}

/* ================================
   PROJECT TASK MODAL
================================ */
function openProjectTaskModal(projectId) {
  const modal = document.getElementById("projectTaskModal");
  const title = document.getElementById("projectTaskModalTitle");
  
  // Reset form
  document.getElementById("projectTaskId").value = "";
  document.getElementById("projectTaskProjectId").value = projectId;
  document.getElementById("projectTaskTitle").value = "";
  document.getElementById("projectTaskDescription").value = "";
  document.getElementById("projectTaskPriority").value = "medium";
  document.getElementById("projectTaskStatus").value = "todo";
  document.getElementById("projectTaskDueDate").value = "";
  document.getElementById("projectTaskAssignedTo").value = "";
  
  title.textContent = "Add Task to Project";
  modal.classList.add("active");
}

function openProjectTaskForEdit(taskId, projectId) {
  const tasks = projectTasks[projectId] || [];
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  
  const modal = document.getElementById("projectTaskModal");
  const title = document.getElementById("projectTaskModalTitle");
  
  document.getElementById("projectTaskId").value = task.id;
  document.getElementById("projectTaskProjectId").value = projectId;
  document.getElementById("projectTaskTitle").value = task.title || "";
  document.getElementById("projectTaskDescription").value = task.description || "";
  document.getElementById("projectTaskPriority").value = task.priority || "medium";
  document.getElementById("projectTaskStatus").value = task.status || "todo";
  document.getElementById("projectTaskDueDate").value = task.due_date || "";
  document.getElementById("projectTaskAssignedTo").value = task.assigned_to || "";
  
  title.textContent = "Edit Task";
  modal.classList.add("active");
}

function closeProjectTaskModal() {
  document.getElementById("projectTaskModal").classList.remove("active");
}

async function saveProjectTask() {
  const id = document.getElementById("projectTaskId").value;
  const projectId = document.getElementById("projectTaskProjectId").value;
  const title = document.getElementById("projectTaskTitle").value.trim();
  
  if (!title) {
    alert("Title is required");
    return;
  }
  
  // Get the client name from the project
  const project = allProjects.find(p => p.id === projectId);
  const clientName = project?.client_name || "";
  
  const taskData = {
    title,
    description: document.getElementById("projectTaskDescription").value.trim(),
    priority: document.getElementById("projectTaskPriority").value,
    status: document.getElementById("projectTaskStatus").value,
    due_date: document.getElementById("projectTaskDueDate").value || null,
    assigned_to: document.getElementById("projectTaskAssignedTo").value.trim() || null,
    project_id: projectId,
    category: clientName // Link to client as well
  };
  
  try {
    if (id) {
      // Update existing task
      const res = await fetch(`${SUPABASE_URL}/tasks?id=eq.${id}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          apikey: ANON_KEY,
          Authorization: "Bearer " + ACCESS_TOKEN,
          Prefer: "return=representation"
        },
        body: JSON.stringify(taskData)
      });
      
      if (!res.ok) throw new Error("Failed to update task");
    } else {
      // Create new task
      const res = await fetch(`${SUPABASE_URL}/tasks`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: ANON_KEY,
          Authorization: "Bearer " + ACCESS_TOKEN,
          Prefer: "return=representation"
        },
        body: JSON.stringify(taskData)
      });
      
      if (!res.ok) throw new Error("Failed to create task");
    }
    
    closeProjectTaskModal();
    await loadProjects();
  } catch (err) {
    alert("Error saving task: " + err.message);
  }
}

/* ================================
   REVENUE PAGE KPIs + CHARTS
================================ */
let grossChartInstance = null;
let watchmakerChartInstance = null;

async function loadRevenueKPIs() {
  const url = `${SUPABASE_URL}/invoices?select=*`;
  const res = await fetch(url, {
    headers: getAuthHeaders()
  });

  if (!res.ok) {
    console.error("Failed to load KPIs");
    return;
  }

  const invoices = await res.json();

  // Build monthly data and watchmaker (exclude Lamar from 15%)
  const months = {};
  const wmMonths = {};
  invoices.forEach(inv => {
    const month = inv.invoice_date?.slice(0, 7);
    if (!month) return;
    const gross = Number(inv.gross_amount || 0);
    if (!months[month]) months[month] = 0;
    months[month] += gross;
    if (!isLamarInvoice(inv)) {
      if (!wmMonths[month]) wmMonths[month] = 0;
      wmMonths[month] += gross * 0.15;
    }
  });

  const labels = Object.keys(months).sort();
  const grossValues = labels.map(m => months[m]);
  const watchmakerValues = labels.map(m => wmMonths[m] || 0);

  // Calculate totals
  const totalGross = grossValues.reduce((sum, v) => sum + v, 0);
  const watchmakerRevenue = watchmakerValues.reduce((sum, v) => sum + v, 0);
  const invoiceCount = invoices.length;

  // Update KPI cards
  document.getElementById("kpiTotalGross").textContent = "$" + totalGross.toLocaleString();
  document.getElementById("kpiWatchmaker").textContent = "$" + watchmakerRevenue.toLocaleString();
  document.getElementById("kpiInvoiceCount").textContent = invoiceCount;

  // Gross Revenue Chart
  const grossCtx = document.getElementById("grossChart").getContext("2d");
  if (grossChartInstance) grossChartInstance.destroy();
  grossChartInstance = new Chart(grossCtx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Gross Revenue",
        data: grossValues,
        backgroundColor: "#1A1A1A",
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: v => "$" + v.toLocaleString() }
        }
      }
    }
  });

  // Watchmaker Revenue Chart
  const wmCtx = document.getElementById("watchmakerChart").getContext("2d");
  if (watchmakerChartInstance) watchmakerChartInstance.destroy();
  watchmakerChartInstance = new Chart(wmCtx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Watchmaker Revenue (15%)",
        data: watchmakerValues,
        backgroundColor: "#FFD60A",
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: v => "$" + v.toLocaleString() }
        }
      }
    }
  });

}

/* ================================
   CLIENT INVOICES PAGE
================================ */
function renderClientInvoicesGrid() {
  const grid = document.getElementById("clientInvoicesGrid");
  // Only show clients that have invoices
  const invoiceClients = CLIENTS.filter(c => c.hasInvoices !== false);
  grid.innerHTML = invoiceClients.map(c => {
    // Escape apostrophes in names for onclick handler
    const safeName = c.name.replace(/'/g, "\\'");
    return `
    <div class="client-card" onclick="openClient('${safeName}', '${c.filter}')">
      <div class="client-card-icon">${c.name.charAt(0)}</div>
      <div class="client-card-name">${c.name}</div>
    </div>
  `;
  }).join("");
}

/* ================================
   CLIENT PAGE
================================ */
let currentClientName = '';

function openClient(name, filter) {
  currentClientName = name;
  document.getElementById("clientTitle").innerText = name;
  document.getElementById("clientHeaderTitle").innerText = name;
  showPage('client');
  loadClientInvoices(filter || name);
  loadClientTasks(name);
}

async function loadClientInvoices(filter) {
  const encoded = encodeURIComponent(filter);
  const url = `${SUPABASE_URL}/invoices?select=*&company_name=ilike.*${encoded}*`;
  
  const res = await fetch(url, {
    headers: getAuthHeaders(),
  });

  if (!res.ok) {
    console.error("loadClientInvoices fetch failed:", res.status, await res.text());
    renderInvoiceTable([]);
    renderMonthlyTotals([]);
    renderClientChart([]);
    return;
  }

  const data = await res.json();

  // Update client KPIs
  const totalGross = data.reduce((sum, inv) => sum + Number(inv.gross_amount || 0), 0);
  const nonLamarGross = data
    .filter(inv => !isLamarInvoice(inv))
    .reduce((sum, inv) => sum + Number(inv.gross_amount || 0), 0);

  document.getElementById("clientTotalGross").textContent = "$" + totalGross.toLocaleString();
  document.getElementById("clientWatchmaker").textContent = "$" + (nonLamarGross * 0.15).toLocaleString();
  document.getElementById("clientInvoiceCount").textContent = data.length;

  renderInvoiceTable(data);
  renderMonthlyTotals(data);
  renderClientChart(data);
}

function renderInvoiceTable(rows) {
  if (!rows.length) {
    document.getElementById("clientInvoices").innerHTML = "<p style='padding:24px;color:#6B6B6B;'>No invoices yet.</p>";
    return;
  }

  let html = `
    <table>
      <thead>
        <tr>
          <th>Month</th>
          <th>Company</th>
          <th>Station</th>
          <th>Invoice #</th>
          <th>Gross</th>
        </tr>
      </thead>
      <tbody>
  `;

  rows.forEach(inv => {
    const month = inv.invoice_date?.slice(0,7) || "";
    const gross = Number(inv.gross_amount || 0);
    html += `
      <tr>
        <td>${month}</td>
        <td>${inv.company_name || ""}</td>
        <td>${inv.station_name || ""}</td>
        <td>${inv.invoice_number || ""}</td>
        <td>$${gross.toLocaleString()}</td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  document.getElementById("clientInvoices").innerHTML = html;
}

function renderMonthlyTotals(rows) {
  const months = {};
  const wmMonths = {};
  rows.forEach(inv => {
    const month = inv.invoice_date?.slice(0,7);
    if (!month) return;
    const gross = Number(inv.gross_amount || 0);
    if (!months[month]) months[month] = 0;
    months[month] += gross;
    if (!isLamarInvoice(inv)) {
      if (!wmMonths[month]) wmMonths[month] = 0;
      wmMonths[month] += gross * 0.15;
    }
  });

  if (!Object.keys(months).length) {
    document.getElementById("clientMonthlyTable").innerHTML = "<p style='padding:24px;color:#6B6B6B;'>No data.</p>";
    return;
  }

  let html = `
    <table>
      <thead>
        <tr>
          <th>Month</th>
          <th>Total Gross</th>
          <th>Watchmaker (15%)</th>
        </tr>
      </thead>
      <tbody>
  `;

  Object.keys(months).sort().forEach(m => {
    html += `
      <tr>
        <td>${m}</td>
        <td>$${months[m].toLocaleString()}</td>
        <td>$${(wmMonths[m] || 0).toLocaleString()}</td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  document.getElementById("clientMonthlyTable").innerHTML = html;
}

let clientChartInstance = null;
function renderClientChart(rows) {
  const months = {};
  rows.forEach(inv => {
    const month = inv.invoice_date?.slice(0,7);
    if (!month) return;
    if (!months[month]) months[month] = 0;
    months[month] += Number(inv.gross_amount || 0);
  });

  const labels = Object.keys(months).sort();
  const values = labels.map(m => months[m]);

  const ctx = document.getElementById("clientChart").getContext("2d");

  if (clientChartInstance) clientChartInstance.destroy();

  clientChartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Gross Revenue",
        data: values,
        backgroundColor: "#FFD60A",
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: v => "$" + v.toLocaleString() }
        }
      }
    }
  });
}

/* ================================
   TASKS CRUD
================================ */
let allTasks = [];
let currentTaskTab = 'all'; // 'all' or 'my'

// Switch between All Tasks and My Tasks tabs
function switchTaskTab(tab) {
  currentTaskTab = tab;
  
  // Update tab styles
  document.getElementById('tabAllTasks').classList.toggle('active', tab === 'all');
  document.getElementById('tabMyTasks').classList.toggle('active', tab === 'my');
  
  // Reload tasks with new filter
  loadTasks();
}

async function loadTasks() {
  const client = document.getElementById("filterClient")?.value || "";
  const priority = document.getElementById("filterPriority")?.value || "";
  const status = document.getElementById("filterStatus")?.value || "";
  
  let url = `${SUPABASE_URL}/tasks?select=*&order=created_at.desc`;
  if (client) url += `&category=eq.${encodeURIComponent(client)}`;
  if (priority) url += `&priority=eq.${priority}`;
  
  // Handle archived filter specially
  if (status === 'archived') {
    url += `&archived_at=not.is.null`;
  } else if (status) {
    url += `&status=eq.${status}&archived_at=is.null`;
  } else {
    // Default: hide archived tasks
    url += `&archived_at=is.null`;
  }

  const res = await fetch(url, {
    headers: getAuthHeaders()
  });

  if (!res.ok) {
    console.error("Failed to load tasks");
    return;
  }

  allTasks = await res.json();
  
  // Get current user info for filtering
  const currentUserName = window.currentSession?.user?.user_metadata?.display_name || 
                          window.currentSession?.user?.email || '';
  const currentUserId = window.currentSession?.user?.id || '';
  
  console.log('Current tab:', currentTaskTab);
  console.log('Current user name:', currentUserName);
  
  // Filter based on current tab
  let filteredTasks = allTasks;
  
  if (currentTaskTab === 'my') {
    // My Tasks: Show ONLY tasks where assigned_to exactly matches current user
    filteredTasks = allTasks.filter(t => t.assigned_to === currentUserName);
  } else {
    // All Tasks: Show public tasks + my private tasks
    filteredTasks = allTasks.filter(t => 
      !t.is_private || t.created_by === currentUserId || t.assigned_to === currentUserName
    );
  }
  
  console.log('Filtered tasks count:', filteredTasks.length);
  
  // Update My Tasks count (only non-archived tasks assigned to me)
  const myTasksCount = allTasks.filter(t => t.assigned_to === currentUserName && !t.archived_at).length;
  const countEl = document.getElementById('myTasksCount');
  if (countEl) countEl.textContent = myTasksCount;
  
  renderTasksTable(filteredTasks);
}

function renderTasksTable(tasks) {
  const tbody = document.getElementById("tasksTableBody");
  if (!tasks.length) {
    const message = currentTaskTab === 'my' 
      ? 'No tasks assigned to you yet.' 
      : 'No tasks found. Create your first task!';
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#6B6B6B;">${message}</td></tr>`;
    return;
  }

  tbody.innerHTML = tasks.map(t => `
    <tr class="task-row-clickable" onclick="openTaskDetail('${t.id}')">
      <td>
        <strong>${escapeHtml(t.title)}</strong>
        ${t.is_private ? '<span class="private-badge">ðŸ”’ Private</span>' : ''}
        ${t.archived_at ? '<span class="archived-badge">ðŸ“¦ Archived</span>' : ''}
      </td>
      <td><span class="badge badge-${t.priority}">${t.priority}</span></td>
      <td><span class="badge badge-${t.status}">${t.status?.replace('_', ' ')}</span></td>
      <td>${t.due_date || 'â€”'}</td>
      <td>${renderAssignedBadge(t.assigned_to)}</td>
      <td>${t.category || 'â€”'}</td>
      <td>
        <button class="action-btn edit" onclick="event.stopPropagation(); editTask('${t.id}')">Edit</button>
        ${t.archived_at 
          ? `<button class="action-btn" onclick="event.stopPropagation(); unarchiveTask('${t.id}')" title="Unarchive">ðŸ“¤</button>`
          : `<button class="action-btn" onclick="event.stopPropagation(); archiveTask('${t.id}')" title="Archive">ðŸ“¦</button>`
        }
        <button class="action-btn delete" onclick="event.stopPropagation(); deleteTask('${t.id}')">Delete</button>
      </td>
    </tr>
  `).join("");
}

// Load tasks for a specific client
async function loadClientTasks(clientName) {
  const encoded = encodeURIComponent(clientName);
  const url = `${SUPABASE_URL}/tasks?select=*&category=eq.${encoded}&order=created_at.desc`;
  
  const res = await fetch(url, {
    headers: getAuthHeaders()
  });

  if (!res.ok) {
    console.error("Failed to load client tasks");
    renderClientTasksTable([]);
    return;
  }

  const tasks = await res.json();
  // Also store in allTasks for editing
  allTasks = tasks;
  renderClientTasksTable(tasks);
}

function renderClientTasksTable(tasks) {
  const tbody = document.getElementById("clientTasksTableBody");
  if (!tasks.length) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#6B6B6B;">No tasks for this client yet.</td></tr>`;
    return;
  }

  tbody.innerHTML = tasks.map(t => `
    <tr class="task-row-clickable" onclick="openTaskDetail('${t.id}')">
      <td><strong>${t.title}</strong></td>
      <td><span class="badge badge-${t.priority}">${t.priority}</span></td>
      <td><span class="badge badge-${t.status}">${t.status?.replace('_', ' ')}</span></td>
      <td>${t.due_date || 'â€”'}</td>
      <td>${renderAssignedBadge(t.assigned_to)}</td>
      <td>
        <button class="action-btn edit" onclick="event.stopPropagation(); editTask('${t.id}')">Edit</button>
        <button class="action-btn delete" onclick="event.stopPropagation(); deleteTask('${t.id}')">Delete</button>
      </td>
    </tr>
  `).join("");
}

// Open task modal pre-filled with current client
function openTaskModalForClient() {
  openTaskModal();
  document.getElementById("taskClient").value = currentClientName;
}

async function createTask(task) {
  const res = await fetch(`${SUPABASE_URL}/tasks`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      apikey: ANON_KEY,
      Authorization: "Bearer " + ACCESS_TOKEN,
      Prefer: "return=representation"
    },
    body: JSON.stringify(task)
  });

  if (!res.ok) {
    console.error("Failed to create task:", await res.text());
    throw new Error("Failed to create task");
  }

  return res.json();
}

async function updateTask(id, updates) {
  // Auto-set completed_at when status changes to done
  if (updates.status === 'done') {
    updates.completed_at = new Date().toISOString();
  } else if (updates.status && updates.status !== 'done') {
    // Clear completed_at if task is moved out of done
    updates.completed_at = null;
  }
  
  const res = await fetch(`${SUPABASE_URL}/tasks?id=eq.${id}`, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
      apikey: ANON_KEY,
      Authorization: "Bearer " + ACCESS_TOKEN,
      Prefer: "return=representation"
    },
    body: JSON.stringify(updates)
  });

  if (!res.ok) {
    console.error("Failed to update task:", await res.text());
    throw new Error("Failed to update task");
  }

  return res.json();
}

async function deleteTask(id) {
  if (!confirm("Are you sure you want to delete this task?")) return;

  const res = await fetch(`${SUPABASE_URL}/tasks?id=eq.${id}`, {
    method: "DELETE",
    headers: {
      apikey: ANON_KEY,
      Authorization: "Bearer " + ACCESS_TOKEN
    }
  });

  if (!res.ok) {
    console.error("Failed to delete task");
    return;
  }

  // Refresh current view
  if (currentPage === 'tasks') loadTasks();
  else if (currentPage === 'kanban') loadKanban();
  else if (currentPage === 'reports') loadReports();
  else if (currentPage === 'client' && currentClientName) loadClientTasks(currentClientName);
}

// Archive a task
async function archiveTask(id) {
  const res = await fetch(`${SUPABASE_URL}/tasks?id=eq.${id}`, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
      apikey: ANON_KEY,
      Authorization: "Bearer " + ACCESS_TOKEN
    },
    body: JSON.stringify({ archived_at: new Date().toISOString() })
  });

  if (!res.ok) {
    console.error("Failed to archive task");
    alert("Failed to archive task");
    return;
  }

  console.log('âœ… Task archived');
  
  // Refresh current view
  if (currentPage === 'tasks') loadTasks();
  else if (currentPage === 'kanban') loadKanban();
  else if (currentPage === 'reports') loadReports();
  else if (currentPage === 'client' && currentClientName) loadClientTasks(currentClientName);
}

// Unarchive a task
async function unarchiveTask(id) {
  const res = await fetch(`${SUPABASE_URL}/tasks?id=eq.${id}`, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
      apikey: ANON_KEY,
      Authorization: "Bearer " + ACCESS_TOKEN
    },
    body: JSON.stringify({ archived_at: null })
  });

  if (!res.ok) {
    console.error("Failed to unarchive task");
    alert("Failed to unarchive task");
    return;
  }

  console.log('âœ… Task unarchived');
  
  // Refresh current view
  if (currentPage === 'tasks') loadTasks();
  else if (currentPage === 'kanban') loadKanban();
  else if (currentPage === 'reports') loadReports();
  else if (currentPage === 'client' && currentClientName) loadClientTasks(currentClientName);
}

/* ================================
   TASK MODAL
================================ */
function openTaskModal(taskId = null) {
  const modal = document.getElementById("taskModal");
  const title = document.getElementById("taskModalTitle");
  
  // Reset form
  document.getElementById("taskId").value = "";
  document.getElementById("taskTitle").value = "";
  document.getElementById("taskDescription").value = "";
  document.getElementById("taskPriority").value = "medium";
  document.getElementById("taskStatus").value = "todo";
  document.getElementById("taskDueDate").value = "";
  document.getElementById("taskAssignedTo").value = "";
  document.getElementById("taskClient").value = "";
  document.getElementById("taskPrivate").checked = false;

  if (taskId) {
    title.textContent = "Edit Task";
    const task = allTasks.find(t => t.id === taskId);
    if (task) {
      document.getElementById("taskId").value = task.id;
      document.getElementById("taskTitle").value = task.title || "";
      document.getElementById("taskDescription").value = task.description || "";
      document.getElementById("taskPriority").value = task.priority || "medium";
      document.getElementById("taskStatus").value = task.status || "todo";
      document.getElementById("taskDueDate").value = task.due_date || "";
      document.getElementById("taskAssignedTo").value = task.assigned_to || "";
      document.getElementById("taskClient").value = task.category || "";
      document.getElementById("taskPrivate").checked = task.is_private || false;
    }
  } else {
    title.textContent = "New Task";
  }

  modal.classList.add("active");
}

function closeTaskModal() {
  document.getElementById("taskModal").classList.remove("active");
}

function editTask(id) {
  openTaskModal(id);
}

/* ================================
   TASK DETAIL MODAL
================================ */
let currentDetailTaskId = null;

async function openTaskDetail(taskId) {
  const task = allTasks.find(t => t.id === taskId);
  if (!task) return;

  currentDetailTaskId = taskId;

  // Set title
  document.getElementById("taskDetailTitle").innerHTML = task.is_private 
    ? `${escapeHtml(task.title)} <span class="private-badge">ðŸ”’ Private</span>`
    : escapeHtml(task.title);

  // Set badges
  document.getElementById("taskDetailBadges").innerHTML = `
    <span class="badge badge-${task.priority}">${task.priority}</span>
    <span class="badge badge-${task.status}">${task.status?.replace('_', ' ')}</span>
  `;

  // Set description
  const descEl = document.getElementById("taskDetailDescription");
  if (task.description) {
    descEl.textContent = task.description;
    descEl.classList.add("description");
  } else {
    descEl.textContent = "No description provided.";
    descEl.classList.remove("description");
  }

  // Set other fields
  document.getElementById("taskDetailDueDate").textContent = task.due_date || "Not set";
  document.getElementById("taskDetailAssignedTo").innerHTML = renderAssignedBadge(task.assigned_to);
  document.getElementById("taskDetailClient").textContent = task.category || "No client";
  
  // Format created date
  if (task.created_at) {
    const created = new Date(task.created_at);
    document.getElementById("taskDetailCreated").textContent = created.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } else {
    document.getElementById("taskDetailCreated").textContent = "â€”";
  }

  // Load and render comments
  const comments = await loadTaskComments(taskId);
  renderTaskComments(comments);

  // Show modal
  document.getElementById("taskDetailModal").classList.add("active");
}

function closeTaskDetailModal() {
  document.getElementById("taskDetailModal").classList.remove("active");
  currentDetailTaskId = null;
}

function editTaskFromDetail() {
  if (currentDetailTaskId) {
    closeTaskDetailModal();
    editTask(currentDetailTaskId);
  }
}

async function saveTask() {
  const id = document.getElementById("taskId").value;
  const title = document.getElementById("taskTitle").value.trim();
  
  if (!title) {
    alert("Title is required");
    return;
  }

  const taskData = {
    title,
    description: document.getElementById("taskDescription").value.trim(),
    priority: document.getElementById("taskPriority").value,
    status: document.getElementById("taskStatus").value,
    due_date: document.getElementById("taskDueDate").value || null,
    assigned_to: document.getElementById("taskAssignedTo").value.trim() || null,
    category: document.getElementById("taskClient").value || null,  // Client stored in category field
    is_private: document.getElementById("taskPrivate").checked
  };

  // Add created_by for new tasks
  if (!id && window.currentSession?.user?.id) {
    taskData.created_by = window.currentSession.user.id;
  }

  // Get original task to check if assigned_to changed
  const originalTask = id ? allTasks.find(t => t.id === id) : null;
  const wasAssignedTo = originalTask?.assigned_to;
  const nowAssignedTo = taskData.assigned_to;

  try {
    // Create or update task
    let savedTaskRows;
    if (id) {
      savedTaskRows = await updateTask(id, taskData);
    } else {
      savedTaskRows = await createTask(taskData);
    }

    // Send email if task is assigned to someone new
    if (nowAssignedTo && nowAssignedTo !== wasAssignedTo) {
      const isReassignment = !!wasAssignedTo;
      await sendAssignmentEmail(nowAssignedTo, taskData, isReassignment ? 'reassigned' : 'assigned');
    }

    closeTaskModal();
    
    // Refresh current view
    if (currentPage === 'tasks') loadTasks();
    else if (currentPage === 'kanban') loadKanban();
    else if (currentPage === 'reports') loadReports();
    else if (currentPage === 'client' && currentClientName) loadClientTasks(currentClientName);
  } catch (err) {
    alert("Error saving task: " + err.message);
  }
}

// Send assignment email to the assigned person
async function sendAssignmentEmail(assignedToName, task, type) {
  console.log('ðŸ” Looking for user:', assignedToName);
  console.log('ðŸ” All profiles:', allUserProfiles.map(p => ({ 
    display_name: p.display_name, 
    email: p.email 
  })));
  
  // Find the user's profile by display_name
  const userProfile = allUserProfiles.find(p => 
    p.display_name === assignedToName || p.email === assignedToName
  );
  
  console.log('ðŸ” Found profile:', userProfile);
  
  if (!userProfile || !userProfile.email) {
    console.log('âŒ Could not find email for:', assignedToName);
    return;
  }
  
  const userEmail = userProfile.email;
  console.log('ðŸ“§ Will send email to:', userEmail);
  
  // Don't send email to yourself
  const currentUserEmail = window.currentSession?.user?.email;
  if (userEmail === currentUserEmail) {
    console.log('â­ï¸ Skipping email - assigned to self');
    return;
  }
  
  const subject = type === 'reassigned' 
    ? `Task Reassigned: ${task.title}`
    : `New Task Assigned: ${task.title}`;
  
  const emailData = {
    to: userEmail,
    subject: subject,
    taskTitle: task.title,
    taskDescription: task.description || 'No description',
    taskPriority: task.priority,
    taskDueDate: task.due_date || 'No due date',
    taskStatus: task.status,
    type: type
  };
  
  try {
    const res = await fetch(`${SUPABASE_BASE_URL}/functions/v1/send-task-email`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${ANON_KEY}`
      },
      body: JSON.stringify(emailData)
    });
    
    if (res.ok) {
      console.log('âœ… Email sent to:', userEmail);
    } else {
      console.error('Failed to send email:', await res.text());
    }
  } catch (err) {
    console.error('Error sending email:', err);
  }
}

/* ================================
   KANBAN BOARD
================================ */
async function loadKanban() {
  // Load non-archived tasks only
  const res = await fetch(`${SUPABASE_URL}/tasks?select=*&archived_at=is.null&order=created_at.desc`, {
    headers: getAuthHeaders()
  });

  if (!res.ok) {
    console.error("Failed to load kanban");
    return;
  }

  allTasks = await res.json();
  
  // Filter out private tasks that don't belong to current user
  const currentUserName = window.currentSession?.user?.user_metadata?.display_name || 
                          window.currentSession?.user?.email || '';
  const currentUserId = window.currentSession?.user?.id || '';
  
  // Calculate 2 days ago
  const twoDaysAgo = new Date();
  twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
  
  const visibleTasks = allTasks.filter(t => {
    // Filter out private tasks that don't belong to current user
    if (t.is_private && t.created_by !== currentUserId && t.assigned_to !== currentUserName) {
      return false;
    }
    
    // Hide completed tasks older than 2 days from the board
    if (t.status === 'done' && t.completed_at) {
      const completedDate = new Date(t.completed_at);
      if (completedDate < twoDaysAgo) {
        return false;
      }
    }
    
    // Also check updated_at for done tasks without completed_at
    if (t.status === 'done' && !t.completed_at && t.updated_at) {
      const updatedDate = new Date(t.updated_at);
      if (updatedDate < twoDaysAgo) {
        return false;
      }
    }
    
    return true;
  });
  
  renderKanban(visibleTasks);
}

function renderKanban(tasks) {
  const statuses = ['todo', 'in_progress', 'review', 'done'];
  
  statuses.forEach(status => {
    const column = document.getElementById(`kanban-${status}`);
    const count = document.getElementById(`count-${status}`);
    const statusTasks = tasks.filter(t => t.status === status);
    
    count.textContent = statusTasks.length;
    
    column.innerHTML = statusTasks.map(t => `
      <div class="kanban-card" draggable="true" data-id="${t.id}" ondragstart="dragStart(event)" ondragend="dragEnd(event)" onclick="if(!event.defaultPrevented) openTaskDetail('${t.id}')">
        <div class="kanban-card-title">
          ${escapeHtml(t.title)}
          ${t.is_private ? '<span class="private-badge">ðŸ”’</span>' : ''}
        </div>
        <div class="kanban-card-meta">
          <span class="badge badge-${t.priority}">${t.priority}</span>
          <span class="kanban-card-due">${t.due_date || ''}</span>
        </div>
        ${t.assigned_to ? `<div style="margin-top:8px;">${renderAssignedBadge(t.assigned_to)}</div>` : ''}
      </div>
    `).join("");
  });

  // Setup drop zones
  document.querySelectorAll('.kanban-cards').forEach(col => {
    col.addEventListener('dragover', dragOver);
    col.addEventListener('drop', drop);
  });
}

function dragStart(e) {
  e.target.classList.add('dragging');
  e.dataTransfer.setData('text/plain', e.target.dataset.id);
}

function dragEnd(e) {
  e.target.classList.remove('dragging');
}

function dragOver(e) {
  e.preventDefault();
}

async function drop(e) {
  e.preventDefault();
  const taskId = e.dataTransfer.getData('text/plain');
  const newStatus = e.target.closest('.kanban-column')?.dataset.status;
  
  if (!newStatus || !taskId) return;

  try {
    await updateTask(taskId, { status: newStatus });
    loadKanban();
  } catch (err) {
    console.error("Failed to update task status");
  }
}

/* ================================
   REPORTS
================================ */
let tasksPerWeekChart = null;
let priorityChart = null;

async function loadReports() {
  const res = await fetch(`${SUPABASE_URL}/tasks?select=*`, {
    headers: getAuthHeaders()
  });

  if (!res.ok) {
    console.error("Failed to load reports");
    return;
  }

  const tasks = await res.json();
  allTasks = tasks;

  // Calculate KPIs
  const today = new Date();
  const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
  
  const completedThisWeek = tasks.filter(t => {
    if (t.status !== 'done') return false;
    const updated = new Date(t.updated_at);
    return updated >= weekAgo;
  }).length;

  const overdue = tasks.filter(t => {
    if (t.status === 'done' || !t.due_date) return false;
    return new Date(t.due_date) < today;
  }).length;

  const highPriority = tasks.filter(t => 
    t.priority === 'high' || t.priority === 'urgent'
  ).length;

  document.getElementById("reportCompletedWeek").textContent = completedThisWeek;
  document.getElementById("reportOverdue").textContent = overdue;
  document.getElementById("reportHighPriority").textContent = highPriority;
  document.getElementById("reportTotal").textContent = tasks.length;

  // Tasks per week chart (last 8 weeks)
  const weeks = {};
  for (let i = 0; i < 8; i++) {
    const weekStart = new Date(today.getTime() - (7 - i) * 7 * 24 * 60 * 60 * 1000);
    const weekLabel = weekStart.toISOString().slice(0, 10);
    weeks[weekLabel] = 0;
  }

  tasks.filter(t => t.status === 'done').forEach(t => {
    const updated = new Date(t.updated_at);
    const weekLabel = new Date(updated.getTime() - updated.getDay() * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
    if (weeks[weekLabel] !== undefined) {
      weeks[weekLabel]++;
    }
  });

  const weekLabels = Object.keys(weeks);
  const weekValues = Object.values(weeks);

  const weekCtx = document.getElementById("tasksPerWeekChart").getContext("2d");
  if (tasksPerWeekChart) tasksPerWeekChart.destroy();
  tasksPerWeekChart = new Chart(weekCtx, {
    type: "bar",
    data: {
      labels: weekLabels.map(d => {
        const date = new Date(d);
        return `${date.getMonth() + 1}/${date.getDate()}`;
      }),
      datasets: [{
        label: "Completed",
        data: weekValues,
        backgroundColor: "#22C55E",
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });

  // Priority distribution pie chart
  const priorityCounts = {
    low: tasks.filter(t => t.priority === 'low').length,
    medium: tasks.filter(t => t.priority === 'medium').length,
    high: tasks.filter(t => t.priority === 'high').length,
    urgent: tasks.filter(t => t.priority === 'urgent').length
  };

  const prioCtx = document.getElementById("priorityChart").getContext("2d");
  if (priorityChart) priorityChart.destroy();
  priorityChart = new Chart(prioCtx, {
    type: "doughnut",
    data: {
      labels: ['Low', 'Medium', 'High', 'Urgent'],
      datasets: [{
        data: [priorityCounts.low, priorityCounts.medium, priorityCounts.high, priorityCounts.urgent],
        backgroundColor: ['#3B82F6', '#22C55E', '#F97316', '#EF4444']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}

/* ================================
   PDF UPLOAD
================================ */
function setupPdfUpload() {
  if (window.pdfjsLib) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  }

  const dropZone = document.getElementById("drop-zone");
  const fileInput = document.getElementById("file-input");

  dropZone.addEventListener("click", () => fileInput.click());

  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.style.borderColor = "#FFD60A";
    dropZone.style.background = "#FFFEF5";
  });

  dropZone.addEventListener("dragleave", () => {
    dropZone.style.borderColor = "";
    dropZone.style.background = "";
  });

  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.style.borderColor = "";
    dropZone.style.background = "";
    handleFiles(e.dataTransfer.files);
  });

  fileInput.addEventListener("change", () => handleFiles(fileInput.files));
}

const rawJson = document.getElementById("rawJson");
const statusEl = document.getElementById("status");

function setStatus(msg) {
  if (statusEl) statusEl.textContent = msg || "";
}

async function handleFiles(fileList) {
  const pdfs = Array.from(fileList).filter(f => f.type === "application/pdf");
  if (!pdfs.length) return;
  for (const file of pdfs) {
    await processPDF(file);
  }
}

async function processPDF(file) {
  try {
    setStatus("Reading " + file.name + "...");
    rawJson.textContent = "Extracting text from " + file.name + "...";
    const text = await extractPdfText(file);
    setStatus("Sending to parser...");
    rawJson.textContent = "Sending to parser...";
    const result = await callFunction(file.name, text);
    setStatus("âœ“ Done!");
    rawJson.textContent = JSON.stringify(result, null, 2);
    const invoice = result.invoice || result;
    if (invoice) {
      await saveInvoiceToSupabase(invoice);
      if (currentPage === 'revenue') loadRevenueKPIs();
    }
  } catch (err) {
    console.error(err);
    rawJson.textContent = "Error: " + err.message;
    setStatus("");
  }
}

async function extractPdfText(file) {
  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
  let text = "";
  const maxPages = Math.min(3, pdf.numPages);
  for (let i = 1; i <= maxPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(t => t.str).join(" ") + "\n";
  }
  return text;
}

async function callFunction(fileName, text) {
  const res = await fetch(FUNCTION_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      apikey: ANON_KEY,
      Authorization: "Bearer " + ACCESS_TOKEN,
    },
    body: JSON.stringify({ fileName, text }),
  });
  return res.json();
}

async function saveInvoiceToSupabase(invoice) {
  const res = await fetch(`${SUPABASE_URL}/invoices`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      apikey: ANON_KEY,
      Authorization: "Bearer " + ACCESS_TOKEN,
      Prefer: "return=representation"
    },
    body: JSON.stringify({
      company_name: invoice.company_name || "",
      invoice_number: invoice.invoice_number || "",
      invoice_date: invoice.invoice_date || "",
      gross_amount: invoice.gross_amount || 0,
      station_name: invoice.station_name || "",
      raw_json: invoice
    })
  });

  if (!res.ok) {
    console.error("Insert failed:", await res.text());
    throw new Error("Failed to save invoice");
  }

  console.log("Invoice saved to Supabase");
}

/* ================================
   USER PROFILES & COLORS
================================ */
// Ensure user has a profile with their email (for email notifications)
async function ensureUserProfile(user) {
  if (!user) return;
  
  const userId = user.id;
  const userEmail = user.email;
  const displayName = user.user_metadata?.display_name || userEmail;
  
  try {
    // Check if profile exists
    const checkRes = await fetch(`${SUPABASE_URL}/profiles?id=eq.${userId}&select=id,email`, {
      headers: getAuthHeaders()
    });
    
    if (checkRes.ok) {
      const profiles = await checkRes.json();
      
      if (profiles.length === 0) {
        // Create profile
        await fetch(`${SUPABASE_URL}/profiles`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: ANON_KEY,
            Authorization: "Bearer " + ACCESS_TOKEN
          },
          body: JSON.stringify({
            id: userId,
            display_name: displayName,
            email: userEmail
          })
        });
        console.log('âœ… Created user profile');
      } else if (!profiles[0].email) {
        // Update profile with email if missing
        await fetch(`${SUPABASE_URL}/profiles?id=eq.${userId}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            apikey: ANON_KEY,
            Authorization: "Bearer " + ACCESS_TOKEN
          },
          body: JSON.stringify({ email: userEmail })
        });
        console.log('âœ… Updated user profile with email');
      }
    }
  } catch (err) {
    console.error("Error ensuring user profile:", err);
  }
}

async function loadAllUserProfiles() {
  try {
    const res = await fetch(`${SUPABASE_URL}/profiles?select=*`, {
      headers: getAuthHeaders()
    });
    
    if (res.ok) {
      allUserProfiles = await res.json();
    } else {
      allUserProfiles = [];
    }
  } catch (err) {
    console.error("Error loading profiles:", err);
    allUserProfiles = [];
  }
}

function populateAssignedToDropdowns() {
  const dropdowns = document.querySelectorAll('#taskAssignedTo, #projectTaskAssignedTo');
  
  dropdowns.forEach(dropdown => {
    // Keep the first "Unassigned" option
    const firstOption = dropdown.querySelector('option');
    dropdown.innerHTML = '';
    dropdown.appendChild(firstOption);
    
    // Add team members
    allUserProfiles.forEach(profile => {
      const option = document.createElement('option');
      option.value = profile.display_name || profile.email;
      option.textContent = profile.display_name || profile.email;
      dropdown.appendChild(option);
    });
  });
}

function getUserColor(assignedTo) {
  if (!assignedTo) return null;
  const profile = allUserProfiles.find(p => 
    p.display_name === assignedTo || p.email === assignedTo
  );
  if (profile?.color) {
    return USER_COLORS.find(c => c.id === profile.color)?.hex || null;
  }
  return null;
}

function renderAssignedBadge(assignedTo) {
  if (!assignedTo) return '<span class="assigned-badge">Unassigned</span>';
  
  const color = getUserColor(assignedTo);
  if (color) {
    return `<span class="assigned-badge">
      <span class="user-dot" style="background: ${color}"></span>
      ${assignedTo}
    </span>`;
  }
  return `<span class="assigned-badge">${assignedTo}</span>`;
}

/* ================================
   PROFILE PAGE
================================ */
async function loadProfile() {
  if (!window.currentSession) return;
  
  const user = window.currentSession.user;
  const userEmail = user.email || "";
  const displayName = user.user_metadata?.display_name || userEmail;
  
  document.getElementById("profileEmail").value = userEmail;
  document.getElementById("profileDisplayName").value = displayName;
  
  // Get current user's profile
  currentUserProfile = allUserProfiles.find(p => p.id === user.id) || null;
  
  // Render color picker
  renderColorPicker();
  
  // Render team members
  renderTeamMembers();
}

function renderColorPicker() {
  const grid = document.getElementById("colorPickerGrid");
  const currentUserId = window.currentSession?.user?.id;
  const currentColor = currentUserProfile?.color;
  
  // Find which colors are taken by other users
  const takenColors = allUserProfiles
    .filter(p => p.id !== currentUserId && p.color)
    .map(p => p.color);
  
  grid.innerHTML = USER_COLORS.map(color => {
    const isTaken = takenColors.includes(color.id);
    const isSelected = currentColor === color.id;
    
    let classes = 'color-option';
    if (isTaken) classes += ' taken';
    if (isSelected) classes += ' selected';
    
    return `
      <div class="${classes}" 
           style="background: ${color.hex}"
           onclick="${isTaken ? '' : `selectColor('${color.id}')`}"
           title="${isTaken ? 'Taken by another user' : color.name}">
        <span class="color-tooltip">${color.name}</span>
      </div>
    `;
  }).join('');
}

async function selectColor(colorId) {
  if (!window.currentSession) return;
  
  const userId = window.currentSession.user.id;
  const msg = document.getElementById("colorMessage");
  
  try {
    // Update profile with new color
    const res = await fetch(`${SUPABASE_URL}/profiles?id=eq.${userId}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        apikey: ANON_KEY,
        Authorization: "Bearer " + ACCESS_TOKEN,
        Prefer: "return=representation"
      },
      body: JSON.stringify({ color: colorId })
    });
    
    if (!res.ok) {
      // If profile doesn't exist, create it
      const createRes = await fetch(`${SUPABASE_URL}/profiles`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: ANON_KEY,
          Authorization: "Bearer " + ACCESS_TOKEN,
          Prefer: "return=representation"
        },
        body: JSON.stringify({
          id: userId,
          display_name: window.currentSession.user.user_metadata?.display_name || window.currentSession.user.email,
          email: window.currentSession.user.email,
          color: colorId
        })
      });
      
      if (!createRes.ok) throw new Error("Failed to save color");
    }
    
    // Reload profiles and re-render
    await loadAllUserProfiles();
    currentUserProfile = allUserProfiles.find(p => p.id === userId);
    renderColorPicker();
    renderTeamMembers();
    
    // Update sidebar avatar color
    const userColor = USER_COLORS.find(c => c.id === colorId)?.hex || '#6B6B6B';
    document.getElementById("userAvatar").style.background = userColor;
    
    msg.className = "profile-message success";
    msg.textContent = "âœ“ Color saved!";
    setTimeout(() => { msg.style.display = 'none'; }, 2000);
    
  } catch (err) {
    msg.className = "profile-message error";
    msg.textContent = "Failed to save color: " + err.message;
  }
}

async function saveProfile() {
  if (!window.currentSession) return;
  
  const userId = window.currentSession.user.id;
  const displayName = document.getElementById("profileDisplayName").value.trim();
  const msg = document.getElementById("profileMessage");
  
  if (!displayName) {
    msg.className = "profile-message error";
    msg.textContent = "Display name is required.";
    return;
  }
  
  try {
    // Update auth user metadata
    await supabaseAuth.auth.updateUser({
      data: { display_name: displayName }
    });
    
    // Update profile table (always include email to ensure it's stored)
    const userEmail = window.currentSession.user.email;
    const res = await fetch(`${SUPABASE_URL}/profiles?id=eq.${userId}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        apikey: ANON_KEY,
        Authorization: "Bearer " + ACCESS_TOKEN
      },
      body: JSON.stringify({ display_name: displayName, email: userEmail })
    });
    
    if (!res.ok) {
      // Create profile if doesn't exist
      await fetch(`${SUPABASE_URL}/profiles`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: ANON_KEY,
          Authorization: "Bearer " + ACCESS_TOKEN
        },
        body: JSON.stringify({
          id: userId,
          display_name: displayName,
          email: userEmail
        })
      });
    }
    
    // Update sidebar
    document.getElementById("userEmail").textContent = displayName;
    document.getElementById("userAvatar").textContent = displayName.charAt(0).toUpperCase();
    
    // Reload profiles
    await loadAllUserProfiles();
    renderTeamMembers();
    populateAssignedToDropdowns();
    
    msg.className = "profile-message success";
    msg.textContent = "âœ“ Profile saved!";
    
  } catch (err) {
    msg.className = "profile-message error";
    msg.textContent = "Failed to save: " + err.message;
  }
}

function renderTeamMembers() {
  const grid = document.getElementById("teamMembersGrid");
  
  if (!allUserProfiles.length) {
    grid.innerHTML = '<p style="color: var(--medium-gray);">No team members yet.</p>';
    return;
  }
  
  grid.innerHTML = allUserProfiles.map(profile => {
    const color = profile.color ? USER_COLORS.find(c => c.id === profile.color)?.hex : '#6B6B6B';
    const initial = (profile.display_name || profile.email || '?').charAt(0).toUpperCase();
    const isCurrentUser = profile.id === window.currentSession?.user?.id;
    
    return `
      <div class="team-member-card" ${isCurrentUser ? 'style="border: 2px solid var(--yellow);"' : ''}>
        <div class="team-member-avatar" style="background: ${color}">${initial}</div>
        <div class="team-member-info">
          <div class="team-member-name">${profile.display_name || 'Unnamed'} ${isCurrentUser ? '(You)' : ''}</div>
          <div class="team-member-email">${profile.email || ''}</div>
        </div>
      </div>
    `;
  }).join('');
}

/* ================================
   TASK COMMENTS
================================ */
async function loadTaskComments(taskId) {
  try {
    const res = await fetch(`${SUPABASE_URL}/task_comments?task_id=eq.${taskId}&order=created_at.asc`, {
      headers: getAuthHeaders()
    });
    
    if (res.ok) {
      return await res.json();
    }
    return [];
  } catch (err) {
    console.error("Error loading comments:", err);
    return [];
  }
}

function renderTaskComments(comments) {
  const container = document.getElementById("taskCommentsList");
  const countEl = document.getElementById("commentCount");
  
  // Update comment count
  countEl.textContent = comments.length;
  
  if (!comments.length) {
    container.innerHTML = `
      <div class="no-comments">
        <div class="no-comments-icon">ðŸ’¬</div>
        No comments yet. Be the first to share your thoughts!
      </div>
    `;
    return;
  }
  
  container.innerHTML = comments.map(comment => {
    const color = comment.user_color ? USER_COLORS.find(c => c.id === comment.user_color)?.hex : '#6B6B6B';
    const initial = (comment.user_name || '?').charAt(0).toUpperCase();
    const time = formatCommentTime(comment.created_at);
    
    // Format content with highlighted @mentions
    const formattedContent = formatMentions(escapeHtml(comment.content));
    
    return `
      <div class="task-comment">
        <div class="task-comment-avatar" style="background: ${color}">${initial}</div>
        <div class="task-comment-content">
          <div class="task-comment-header">
            <span class="task-comment-author">${escapeHtml(comment.user_name || 'Unknown')}</span>
            <span class="task-comment-time">${time}</span>
          </div>
          <div class="task-comment-text">${formattedContent}</div>
        </div>
      </div>
    `;
  }).join('');
  
  // Smooth scroll to bottom
  setTimeout(() => {
    container.scrollTop = container.scrollHeight;
  }, 100);
}

// Format @mentions with highlighting
function formatMentions(text) {
  // Match @name or @"name with spaces"
  return text.replace(/@([a-zA-Z0-9_]+|&quot;[^&]+&quot;|&#39;[^&]+&#39;)/g, '<span class="mention">@$1</span>');
}

// Helper to format comment time nicely
function formatCommentTime(dateStr) {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric'
  });
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function addTaskComment() {
  if (!currentDetailTaskId || !window.currentSession) return;
  
  const input = document.getElementById("taskCommentInput");
  const btn = document.getElementById("postCommentBtn");
  const btnText = document.getElementById("postCommentText");
  const content = input.value.trim();
  
  if (!content) return;
  
  const user = window.currentSession.user;
  const userName = user.user_metadata?.display_name || user.email;
  const userProfile = allUserProfiles.find(p => p.id === user.id);
  const userColor = userProfile?.color || null;
  
  // Show loading state
  btn.disabled = true;
  btnText.innerHTML = '<span class="spinner"></span>';
  
  try {
    const res = await fetch(`${SUPABASE_URL}/task_comments`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        apikey: ANON_KEY,
        Authorization: "Bearer " + ACCESS_TOKEN,
        Prefer: "return=representation"
      },
      body: JSON.stringify({
        task_id: currentDetailTaskId,
        user_id: user.id,
        user_name: userName,
        user_color: userColor,
        content: content
      })
    });
    
    if (!res.ok) throw new Error("Failed to add comment");
    
    // Check for @mentions and create notifications
    await processMentions(content, currentDetailTaskId, userName, user.id);
    
    // Clear input with smooth effect
    input.value = "";
    
    // Reload comments
    const comments = await loadTaskComments(currentDetailTaskId);
    renderTaskComments(comments);
    
    // Focus back on input for quick follow-up
    input.focus();
    
  } catch (err) {
    console.error("Error adding comment:", err);
    // Show error briefly
    btnText.textContent = 'âŒ';
    setTimeout(() => {
      btnText.textContent = 'Post';
    }, 1500);
  } finally {
    // Reset button state
    btn.disabled = false;
    btnText.textContent = 'Post';
  }
}

// Process @mentions in comments and create notifications
async function processMentions(content, taskId, fromUserName, fromUserId) {
  console.log('ðŸ” processMentions called:', { content, taskId, fromUserName });
  
  // Find all @mentions (matches @name or @"name with spaces")
  const mentionPattern = /@([a-zA-Z0-9_]+|"[^"]+"|'[^']+')/g;
  const mentions = content.match(mentionPattern);
  
  console.log('ðŸ” Found mentions:', mentions);
  
  if (!mentions || mentions.length === 0) {
    console.log('ðŸ” No mentions found');
    return;
  }
  
  // Make sure profiles are loaded
  if (!allUserProfiles || allUserProfiles.length === 0) {
    console.log('ðŸ” Loading user profiles...');
    await loadAllUserProfiles();
  }
  
  console.log('ðŸ” Available profiles:', allUserProfiles.map(p => p.display_name));
  
  // Get the task title for the notification
  const task = allTasks.find(t => t.id === taskId);
  const taskTitle = task?.title || 'a task';
  
  for (const mention of mentions) {
    // Clean up the mention (remove @ and quotes)
    let mentionName = mention.substring(1).replace(/['"]/g, '').trim();
    console.log('ðŸ” Processing mention:', mentionName);
    
    // Find the user by display_name (case-insensitive, exact or partial match)
    const mentionedUser = allUserProfiles.find(p => {
      const displayName = (p.display_name || '').toLowerCase().trim();
      const email = (p.email || '').toLowerCase().trim();
      const searchName = mentionName.toLowerCase().trim();
      
      // Exact match (case-insensitive)
      if (displayName === searchName || email === searchName) return true;
      
      // Partial match - check if search name is contained in display name
      if (displayName && displayName.includes(searchName)) return true;
      
      // Check if display name starts with search name
      if (displayName && displayName.startsWith(searchName)) return true;
      
      return false;
    });
    
    console.log('ðŸ” Found user:', mentionedUser ? `${mentionedUser.display_name} (${mentionedUser.id})` : 'NOT FOUND');
    console.log('ðŸ” Search was for:', mentionName);
    console.log('ðŸ” Available names:', allUserProfiles.map(p => p.display_name || p.email));
    
    if (mentionedUser) {
      // Create notification for the mentioned user
      try {
        const notificationData = {
          user_id: mentionedUser.id,
          type: 'mention',
          title: `${fromUserName} mentioned you`,
          message: `in "${taskTitle}": ${content.substring(0, 100)}${content.length > 100 ? '...' : ''}`,
          task_id: taskId,
          from_user_id: fromUserId,
          from_user_name: fromUserName
        };
        
        console.log('ðŸ” Creating notification:', notificationData);
        console.log('ðŸ” Using ACCESS_TOKEN:', ACCESS_TOKEN ? ACCESS_TOKEN.substring(0, 20) + '...' : 'NONE');
        
        const res = await fetch(`${SUPABASE_URL}/notifications`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: ANON_KEY,
            Authorization: "Bearer " + ACCESS_TOKEN,
            Prefer: "return=representation"
          },
          body: JSON.stringify(notificationData)
        });
        
        console.log('ðŸ” Notification response status:', res.status);
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error('âŒ Failed to create notification:', res.status, errorText);
          alert(`Failed to create notification: ${res.status} - ${errorText}`);
        } else {
          const result = await res.json();
          console.log('âœ… Notification created:', result);
          
          // Refresh notifications and badge
          await loadUserNotifications();
          updateNotificationBadge();
          
          // Refresh notifications page if open
          if (currentPage === 'notifications') {
            renderNotifications();
          }
        }
      } catch (err) {
        console.error('âŒ Error creating notification:', err);
      }
    } else if (!mentionedUser) {
      console.log('âš ï¸ User not found for mention:', mentionName);
    }
  }
}

// Handle Enter key in comment input
document.addEventListener('keydown', function(e) {
  const input = e.target;
  if (input.id === 'taskCommentInput') {
    const autocomplete = document.getElementById('mentionAutocomplete');
    
    // Handle autocomplete navigation
    if (autocomplete && !autocomplete.classList.contains('hidden')) {
      const items = autocomplete.querySelectorAll('.mention-autocomplete-item');
      const selected = autocomplete.querySelector('.mention-autocomplete-item.selected');
      let selectedIndex = selected ? Array.from(items).indexOf(selected) : -1;
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (selected) selected.classList.remove('selected');
        selectedIndex = (selectedIndex + 1) % items.length;
        items[selectedIndex].classList.add('selected');
        items[selectedIndex].scrollIntoView({ block: 'nearest' });
        return;
      }
      
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (selected) selected.classList.remove('selected');
        selectedIndex = selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1;
        items[selectedIndex].classList.add('selected');
        items[selectedIndex].scrollIntoView({ block: 'nearest' });
        return;
      }
      
      if (e.key === 'Enter' && selected) {
        e.preventDefault();
        const displayName = selected.dataset.name;
        insertMention(input, displayName);
        return;
      }
      
      if (e.key === 'Escape') {
        autocomplete.classList.add('hidden');
        return;
      }
    }
    
    // Post comment on Enter (if not in autocomplete)
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      addTaskComment();
    }
  }
});

// Handle @mention autocomplete
document.addEventListener('input', function(e) {
  if (e.target.id === 'taskCommentInput') {
    handleMentionAutocomplete(e.target);
  }
});

// Close autocomplete when clicking outside
document.addEventListener('click', function(e) {
  const autocomplete = document.getElementById('mentionAutocomplete');
  const input = document.getElementById('taskCommentInput');
  
  if (autocomplete && !autocomplete.contains(e.target) && e.target !== input) {
    autocomplete.classList.add('hidden');
  }
});

// Show autocomplete dropdown for @mentions
function handleMentionAutocomplete(input) {
  const value = input.value;
  const cursorPos = input.selectionStart;
  const textBeforeCursor = value.substring(0, cursorPos);
  const lastAtIndex = textBeforeCursor.lastIndexOf('@');
  
  const autocomplete = document.getElementById('mentionAutocomplete');
  
  // Check if we're typing an @mention
  if (lastAtIndex !== -1) {
    const textAfterAt = textBeforeCursor.substring(lastAtIndex + 1);
    // Only show if there's no space after @
    if (!textAfterAt.includes(' ') && !textAfterAt.includes('\n')) {
      showMentionAutocomplete(input, textAfterAt, lastAtIndex);
      return;
    }
  }
  
  // Hide autocomplete
  if (autocomplete) {
    autocomplete.classList.add('hidden');
  }
}

// Show mention autocomplete dropdown
function showMentionAutocomplete(input, searchText, atIndex) {
  const autocomplete = document.getElementById('mentionAutocomplete');
  if (!autocomplete) return;
  
  // Make sure profiles are loaded
  if (!allUserProfiles || allUserProfiles.length === 0) {
    loadAllUserProfiles().then(() => {
      showMentionAutocomplete(input, searchText, atIndex);
    });
    return;
  }
  
  // Filter users by search text (case-insensitive)
  const searchLower = searchText.toLowerCase();
  const filtered = allUserProfiles.filter(p => {
    const name = (p.display_name || '').toLowerCase();
    const email = (p.email || '').toLowerCase();
    return name.includes(searchLower) || email.includes(searchLower);
  });
  
  if (filtered.length === 0) {
    autocomplete.classList.add('hidden');
    return;
  }
  
  // Render autocomplete items
  autocomplete.innerHTML = filtered.map((profile, index) => {
    const name = profile.display_name || profile.email || 'Unknown';
    const initial = name.charAt(0).toUpperCase();
    const color = profile.color ? USER_COLORS.find(c => c.id === profile.color)?.hex : '#6B6B6B';
    const selectedClass = index === 0 ? 'selected' : '';
    
    return `
      <div class="mention-autocomplete-item ${selectedClass}" 
           data-name="${escapeHtml(name)}"
           onclick="insertMention(document.getElementById('taskCommentInput'), '${escapeHtml(name)}')">
        <div class="mention-autocomplete-item-avatar" style="background: ${color}">${initial}</div>
        <div>
          <div class="mention-autocomplete-item-name">${escapeHtml(name)}</div>
          ${profile.email ? `<div class="mention-autocomplete-item-email">${escapeHtml(profile.email)}</div>` : ''}
        </div>
      </div>
    `;
  }).join('');
  
  autocomplete.classList.remove('hidden');
}

// Insert mention into input
function insertMention(input, displayName) {
  const value = input.value;
  const cursorPos = input.selectionStart;
  const textBeforeCursor = value.substring(0, cursorPos);
  const textAfterCursor = value.substring(cursorPos);
  const lastAtIndex = textBeforeCursor.lastIndexOf('@');
  
  if (lastAtIndex === -1) return;
  
  const textBeforeAt = value.substring(0, lastAtIndex);
  const newValue = textBeforeAt + '@' + displayName + ' ' + textAfterCursor;
  
  input.value = newValue;
  const newCursorPos = lastAtIndex + displayName.length + 2; // +1 for @, +1 for space
  input.setSelectionRange(newCursorPos, newCursorPos);
  input.focus();
  
  // Hide autocomplete
  const autocomplete = document.getElementById('mentionAutocomplete');
  if (autocomplete) {
    autocomplete.classList.add('hidden');
  }
  
  // Continue handling autocomplete
  handleMentionAutocomplete(input);
}

/* ================================
   NOTIFICATIONS
================================ */
let userNotifications = [];

// Get read notification IDs from localStorage
function getReadNotificationIds() {
  try {
    const stored = localStorage.getItem('readNotifications');
    return stored ? JSON.parse(stored) : [];
  } catch {
    return [];
  }
}

// Save read notification IDs to localStorage
function saveReadNotificationIds(ids) {
  localStorage.setItem('readNotifications', JSON.stringify(ids));
}

// Load tasks assigned to current user and @mention notifications
async function loadUserNotifications() {
  if (!window.currentSession) return;
  
  const userName = window.currentSession.user.user_metadata?.display_name || window.currentSession.user.email;
  const userId = window.currentSession.user.id;
  const readIds = getReadNotificationIds();
  
  userNotifications = [];
  
  try {
    // Load task assignments
    const tasksRes = await fetch(`${SUPABASE_URL}/tasks?select=*&assigned_to=eq.${encodeURIComponent(userName)}&order=created_at.desc`, {
      headers: getAuthHeaders()
    });
    
    if (tasksRes.ok) {
      const tasks = await tasksRes.json();
      
      // Convert tasks to notifications
      const taskNotifs = tasks.map(task => ({
        id: 'task_' + task.id,
        type: 'task_assigned',
        title: 'Task Assigned',
        message: `You have been assigned to: "${task.title}"`,
        taskTitle: task.title,
        taskId: task.id,
        priority: task.priority,
        dueDate: task.due_date,
        createdAt: task.created_at,
        read: readIds.includes('task_' + task.id)
      }));
      
      userNotifications.push(...taskNotifs);
    }
    
    // Load @mention notifications from notifications table (filtered by current user)
    const mentionsRes = await fetch(`${SUPABASE_URL}/notifications?select=*&user_id=eq.${userId}&order=created_at.desc`, {
      headers: getAuthHeaders()
    });
    
    if (mentionsRes.ok) {
      const mentions = await mentionsRes.json();
      console.log('ðŸ” Loaded mention notifications:', mentions);
      
      const mentionNotifs = mentions.map(m => ({
        id: 'mention_' + m.id,
        dbId: m.id,
        type: 'mention',
        title: m.title,
        message: m.message,
        taskId: m.task_id,
        fromUser: m.from_user_name,
        createdAt: m.created_at,
        read: m.read || readIds.includes('mention_' + m.id)
      }));
      
      userNotifications.push(...mentionNotifs);
    } else {
      console.error('âŒ Failed to load notifications:', mentionsRes.status, await mentionsRes.text());
    }
    
    // Sort all notifications by date (newest first)
    userNotifications.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    updateNotificationBadge();
  } catch (err) {
    console.error("Error loading notifications:", err);
  }
}

// Update the notification badge count
function updateNotificationBadge() {
  const badge = document.getElementById('notificationBadge');
  const unreadCount = userNotifications.filter(n => !n.read).length;
  
  if (unreadCount > 0) {
    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
}

// Load and render notifications page
async function loadNotifications() {
  await loadUserNotifications();
  renderNotifications();
}

function renderNotifications() {
  const container = document.getElementById('notificationsList');
  
  if (!userNotifications.length) {
    container.innerHTML = `
      <div class="no-notifications">
        <div class="no-notifications-icon">ðŸ””</div>
        <div class="no-notifications-text">No notifications yet</div>
        <div class="no-notifications-subtext">You'll see notifications here when you're mentioned or assigned tasks</div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = userNotifications.map(notif => {
    const timeAgo = formatCommentTime(notif.createdAt);
    const isMention = notif.type === 'mention';
    const icon = isMention ? 'ðŸ’¬' : 'ðŸ“‹';
    const unreadClass = notif.read ? '' : 'unread';
    
    return `
      <div class="notification-item ${unreadClass}" onclick="handleNotificationClick('${notif.id}', '${notif.taskId || ''}')">
        <div class="notification-icon" style="background: ${isMention ? 'var(--blue)' : 'var(--purple)'}">${icon}</div>
        <div class="notification-content">
          <div class="notification-title">${escapeHtml(notif.title)}</div>
          <div class="notification-message">${escapeHtml(notif.message)}</div>
          <div class="notification-time">${timeAgo}</div>
        </div>
        ${!notif.read ? '<div class="notification-actions"><button class="mark-read-btn" onclick="event.stopPropagation(); markNotificationRead(\''+notif.id+'\')">Mark read</button></div>' : ''}
      </div>
    `;
  }).join('');
}

// Handle clicking on a notification
function handleNotificationClick(notifId, taskId) {
  // Mark as read
  markNotificationRead(notifId);
  
  // Navigate to the task
  if (taskId) {
    // Load tasks first to ensure allTasks is populated
    loadTasks().then(() => {
      openTaskDetail(taskId);
    });
  }
}

// Mark a single notification as read
async function markNotificationRead(notifId) {
  const notif = userNotifications.find(n => n.id === notifId);
  if (notif && !notif.read) {
    notif.read = true;
    
    // Save to localStorage
    const readIds = getReadNotificationIds();
    if (!readIds.includes(notifId)) {
      readIds.push(notifId);
      saveReadNotificationIds(readIds);
    }
    
    // If it's a database notification (mention), mark it as read in the database too
    if (notif.dbId) {
      try {
        await fetch(`${SUPABASE_URL}/notifications?id=eq.${notif.dbId}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            apikey: ANON_KEY,
            Authorization: "Bearer " + ACCESS_TOKEN
          },
          body: JSON.stringify({ read: true })
        });
      } catch (err) {
        console.error("Error marking notification as read:", err);
      }
    }
    
    updateNotificationBadge();
    renderNotifications();
  }
}

// Mark all notifications as read
function markAllNotificationsRead() {
  const readIds = getReadNotificationIds();
  
  userNotifications.forEach(notif => {
    notif.read = true;
    if (!readIds.includes(notif.id)) {
      readIds.push(notif.id);
    }
  });
  
  saveReadNotificationIds(readIds);
  updateNotificationBadge();
  renderNotifications();
}

// Check for new notifications periodically
function startNotificationPolling() {
  // Initial load
  loadUserNotifications();
  
  // Check every 60 seconds for new assignments
  setInterval(() => {
    loadUserNotifications();
  }, 60000);
}


/* ================================
   REAL-TIME SUBSCRIPTIONS
================================ */
let realtimeChannel = null;

function setupRealtimeSubscriptions() {
  // Clean up existing subscription if any
  if (realtimeChannel) {
    supabaseAuth.removeChannel(realtimeChannel);
  }
  
  // Create a channel for all table changes
  realtimeChannel = supabaseAuth
    .channel('crm-realtime')
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'tasks' },
      (payload) => {
        console.log('ðŸ“¡ Task change detected:', payload.eventType);
        handleTaskChange(payload);
      }
    )
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'projects' },
      (payload) => {
        console.log('ðŸ“¡ Project change detected:', payload.eventType);
        handleProjectChange(payload);
      }
    )
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'task_comments' },
      (payload) => {
        console.log('ðŸ“¡ Comment change detected:', payload.eventType);
        handleCommentChange(payload);
      }
    )
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'invoices' },
      (payload) => {
        console.log('ðŸ“¡ Invoice change detected:', payload.eventType);
        handleInvoiceChange(payload);
      }
    )
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') {
        console.log('âœ… Real-time subscriptions active');
        showRealtimeIndicator(true);
      } else {
        console.log('âš ï¸ Real-time status:', status);
        showRealtimeIndicator(false);
      }
    });
}

// Show a subtle indicator that real-time is connected
function showRealtimeIndicator(connected) {
  let indicator = document.getElementById('realtimeIndicator');
  if (!indicator) {
    indicator = document.createElement('div');
    indicator.id = 'realtimeIndicator';
    indicator.style.cssText = `
      position: fixed;
      bottom: 16px;
      right: 16px;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s;
      opacity: 0.8;
    `;
    document.body.appendChild(indicator);
  }
  
  if (connected) {
    indicator.style.background = '#22C55E';
    indicator.style.color = 'white';
    indicator.innerHTML = '<span style="width:6px;height:6px;background:white;border-radius:50%;animation:pulse 2s infinite;"></span> Live';
  } else {
    indicator.style.background = '#EF4444';
    indicator.style.color = 'white';
    indicator.innerHTML = '<span style="width:6px;height:6px;background:white;border-radius:50%;"></span> Reconnecting...';
  }
  
  // Hide indicator after 3 seconds when connected
  if (connected) {
    setTimeout(() => {
      indicator.style.opacity = '0';
    }, 3000);
  }
}

// Handle task changes
function handleTaskChange(payload) {
  const currentPage = document.querySelector('.page:not(.hidden)')?.id;
  
  // Refresh data based on current page
  if (currentPage === 'page-tasks') {
    loadTasks();
    showUpdateToast('Tasks updated');
  } else if (currentPage === 'page-kanban') {
    loadKanban();
    showUpdateToast('Progress Board updated');
  } else if (currentPage === 'page-projects') {
    // Reload project tasks
    loadProjects();
    showUpdateToast('Project tasks updated');
  } else if (currentPage === 'page-reports') {
    loadReports();
  } else if (currentPage === 'page-dashboard') {
    loadDashboardStats();
  }
  
  // Always update notifications when tasks change
  loadUserNotifications();
  
  // If task detail modal is open and it's the changed task, refresh comments
  if (currentDetailTaskId && payload.new?.id === currentDetailTaskId) {
    // Refresh the task in allTasks
    const idx = allTasks.findIndex(t => t.id === currentDetailTaskId);
    if (idx !== -1 && payload.new) {
      allTasks[idx] = payload.new;
    }
  }
}

// Check if a task was assigned/reassigned to current user
function checkForReassignment(payload) {
  // No-op now â€“ we reverted to original behavior (emails only on create via saveTask)
  return;
}

// Show a prominent notification for task assignment
function showAssignmentNotification(task, type) {
  // Show in-app notification banner
  showAssignmentBanner(task, type);
  
  // Add to local notifications (mark as unread)
  const readIds = getReadNotificationIds();
  const filteredIds = readIds.filter(id => id !== task.id);
  saveReadNotificationIds(filteredIds);
  
  // Update badge immediately
  loadUserNotifications();
}

// Show a banner notification at the top of the screen
function showAssignmentBanner(task, type) {
  // Remove existing banner
  const existing = document.getElementById('assignmentBanner');
  if (existing) existing.remove();
  
  const banner = document.createElement('div');
  banner.id = 'assignmentBanner';
  banner.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #1A1A1A 0%, #2D2D2D 100%);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 16px;
    animation: slideDown 0.4s ease;
    max-width: 90%;
    cursor: pointer;
  `;
  
  const icon = type === 'reassigned' ? 'ðŸ”„' : 'ðŸ“‹';
  const title = type === 'reassigned' ? 'Task Reassigned to You' : 'New Task Assigned';
  
  banner.innerHTML = `
    <div style="font-size: 28px;">${icon}</div>
    <div style="flex: 1;">
      <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${title}</div>
      <div style="font-size: 13px; opacity: 0.9;">${escapeHtml(task.title)}</div>
      <div style="font-size: 11px; opacity: 0.7; margin-top: 4px;">
        <span class="badge badge-${task.priority}" style="font-size: 10px;">${task.priority}</span>
        ${task.due_date ? `â€¢ Due: ${task.due_date}` : ''}
      </div>
    </div>
    <button onclick="this.parentElement.remove()" style="
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
    ">âœ•</button>
  `;
  
  // Click to view task
  banner.onclick = (e) => {
    if (e.target.tagName !== 'BUTTON') {
      banner.remove();
      // Load tasks and open detail
      loadTasks().then(() => {
        openTaskDetail(task.id);
      });
    }
  };
  
  // Add animation keyframes
  if (!document.getElementById('bannerStyles')) {
    const style = document.createElement('style');
    style.id = 'bannerStyles';
    style.textContent = `
      @keyframes slideDown {
        from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }
  
  document.body.appendChild(banner);
  
  // Auto-remove after 8 seconds
  setTimeout(() => {
    if (banner.parentElement) {
      banner.style.animation = 'slideDown 0.3s ease reverse';
      setTimeout(() => banner.remove(), 300);
    }
  }, 8000);
}

// Handle project changes
function handleProjectChange(payload) {
  const currentPage = document.querySelector('.page:not(.hidden)')?.id;
  
  if (currentPage === 'page-projects') {
    loadProjects();
    showUpdateToast('Projects updated');
  } else if (currentPage === 'page-dashboard') {
    loadDashboardStats();
  }
}

// Handle comment changes
async function handleCommentChange(payload) {
  // If task detail modal is open and comment is for that task, refresh comments
  if (currentDetailTaskId && payload.new?.task_id === currentDetailTaskId) {
    const comments = await loadTaskComments(currentDetailTaskId);
    renderTaskComments(comments);
    showUpdateToast('New comment added');
  }
}

// Handle invoice changes
function handleInvoiceChange(payload) {
  const currentPage = document.querySelector('.page:not(.hidden)')?.id;
  
  if (currentPage === 'page-revenue') {
    loadRevenueKPIs();
    showUpdateToast('Revenue data updated');
  } else if (currentPage === 'page-clients') {
    // Refresh if on client invoices page
    showUpdateToast('Invoice data updated');
  } else if (currentPage === 'page-client') {
    // Refresh current client data
    if (currentClientName) {
      const client = CLIENTS.find(c => c.name === currentClientName);
      if (client) {
        loadClientInvoices(client.filter);
      }
    }
    showUpdateToast('Client data updated');
  } else if (currentPage === 'page-dashboard') {
    loadDashboardStats();
  }
}

// Show a toast notification for updates
function showUpdateToast(message) {
  // Remove existing toast
  const existingToast = document.getElementById('updateToast');
  if (existingToast) {
    existingToast.remove();
  }
  
  const toast = document.createElement('div');
  toast.id = 'updateToast';
  toast.style.cssText = `
    position: fixed;
    bottom: 60px;
    right: 16px;
    background: var(--black, #1A1A1A);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    z-index: 1001;
    display: flex;
    align-items: center;
    gap: 8px;
    animation: slideUp 0.3s ease;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  `;
  toast.innerHTML = `<span style="color: #22C55E;">â—</span> ${message}`;
  
  // Add animation keyframes if not exists
  if (!document.getElementById('toastStyles')) {
    const style = document.createElement('style');
    style.id = 'toastStyles';
    style.textContent = `
      @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }
  
  document.body.appendChild(toast);
  
  // Remove after 3 seconds
  setTimeout(() => {
    toast.style.animation = 'slideUp 0.3s ease reverse';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}
</script>
</body>
</html>

